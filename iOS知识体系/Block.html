<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Block | 文档</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/assets/css/0.styles.e4d8b86b.css" as="style"><link rel="preload" href="/assets/js/app.9de76d75.js" as="script"><link rel="preload" href="/assets/js/2.98ea7a63.js" as="script"><link rel="preload" href="/assets/js/9.04a00c43.js" as="script"><link rel="prefetch" href="/assets/js/10.fa8eed47.js"><link rel="prefetch" href="/assets/js/11.f98f25e0.js"><link rel="prefetch" href="/assets/js/12.1ab9b5a3.js"><link rel="prefetch" href="/assets/js/13.75251b00.js"><link rel="prefetch" href="/assets/js/14.b5068189.js"><link rel="prefetch" href="/assets/js/15.33abd7e1.js"><link rel="prefetch" href="/assets/js/16.34ed8053.js"><link rel="prefetch" href="/assets/js/17.b3d52ea3.js"><link rel="prefetch" href="/assets/js/18.cbe71205.js"><link rel="prefetch" href="/assets/js/19.c632cb86.js"><link rel="prefetch" href="/assets/js/20.90d9a221.js"><link rel="prefetch" href="/assets/js/21.15cb7700.js"><link rel="prefetch" href="/assets/js/22.62ea968a.js"><link rel="prefetch" href="/assets/js/23.b743fdd5.js"><link rel="prefetch" href="/assets/js/24.5d157647.js"><link rel="prefetch" href="/assets/js/25.1935fba3.js"><link rel="prefetch" href="/assets/js/26.fd22f8ee.js"><link rel="prefetch" href="/assets/js/27.f47adfe7.js"><link rel="prefetch" href="/assets/js/28.d9f5719d.js"><link rel="prefetch" href="/assets/js/29.82cbf665.js"><link rel="prefetch" href="/assets/js/3.b96f613e.js"><link rel="prefetch" href="/assets/js/30.9f901f01.js"><link rel="prefetch" href="/assets/js/31.d9e2f61c.js"><link rel="prefetch" href="/assets/js/32.b14052e9.js"><link rel="prefetch" href="/assets/js/33.1b2e5efd.js"><link rel="prefetch" href="/assets/js/34.4bf7f44f.js"><link rel="prefetch" href="/assets/js/35.98d5fd2b.js"><link rel="prefetch" href="/assets/js/36.cdaf1c2f.js"><link rel="prefetch" href="/assets/js/37.a67bdb9a.js"><link rel="prefetch" href="/assets/js/38.5d856b83.js"><link rel="prefetch" href="/assets/js/39.27169c95.js"><link rel="prefetch" href="/assets/js/4.268c621c.js"><link rel="prefetch" href="/assets/js/40.8763c647.js"><link rel="prefetch" href="/assets/js/41.cd839f43.js"><link rel="prefetch" href="/assets/js/42.a97bf97a.js"><link rel="prefetch" href="/assets/js/43.fd126bb1.js"><link rel="prefetch" href="/assets/js/44.50e2b10d.js"><link rel="prefetch" href="/assets/js/45.0c29263b.js"><link rel="prefetch" href="/assets/js/46.fdee27aa.js"><link rel="prefetch" href="/assets/js/47.c7c7e966.js"><link rel="prefetch" href="/assets/js/48.80bc6f0a.js"><link rel="prefetch" href="/assets/js/49.d457b0ac.js"><link rel="prefetch" href="/assets/js/5.f577ebb9.js"><link rel="prefetch" href="/assets/js/50.cea3b0e6.js"><link rel="prefetch" href="/assets/js/51.eaab3e31.js"><link rel="prefetch" href="/assets/js/52.010a2dfb.js"><link rel="prefetch" href="/assets/js/53.3622f7b6.js"><link rel="prefetch" href="/assets/js/54.817aba2b.js"><link rel="prefetch" href="/assets/js/55.c3984ff9.js"><link rel="prefetch" href="/assets/js/56.6f20785e.js"><link rel="prefetch" href="/assets/js/57.07c7f6fc.js"><link rel="prefetch" href="/assets/js/58.4ec50d24.js"><link rel="prefetch" href="/assets/js/59.626b42b0.js"><link rel="prefetch" href="/assets/js/6.b9249342.js"><link rel="prefetch" href="/assets/js/60.ba2af5c7.js"><link rel="prefetch" href="/assets/js/61.6e22c298.js"><link rel="prefetch" href="/assets/js/62.df85ea27.js"><link rel="prefetch" href="/assets/js/63.cd3c1f6a.js"><link rel="prefetch" href="/assets/js/64.d0f75a86.js"><link rel="prefetch" href="/assets/js/65.12e0c392.js"><link rel="prefetch" href="/assets/js/66.aac422ac.js"><link rel="prefetch" href="/assets/js/67.3ff890c6.js"><link rel="prefetch" href="/assets/js/68.c6d12518.js"><link rel="prefetch" href="/assets/js/69.455e0c09.js"><link rel="prefetch" href="/assets/js/7.375eddd0.js"><link rel="prefetch" href="/assets/js/70.73d975e7.js"><link rel="prefetch" href="/assets/js/71.66528e07.js"><link rel="prefetch" href="/assets/js/72.a608a326.js"><link rel="prefetch" href="/assets/js/73.b8ed0811.js"><link rel="prefetch" href="/assets/js/74.68f4db5d.js"><link rel="prefetch" href="/assets/js/75.85059bdc.js"><link rel="prefetch" href="/assets/js/8.a04b9d9b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e4d8b86b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">文档</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>iOS</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/iOS知识体系/UI视图.html" class="sidebar-link">UI视图</a></li><li><a href="/iOS知识体系/Objective-C.html" class="sidebar-link">Objective-C</a></li><li><a href="/iOS知识体系/Swift.html" class="sidebar-link">Swift</a></li><li><a href="/iOS知识体系/Runtime.html" class="sidebar-link">Runtime</a></li><li><a href="/iOS知识体系/内存管理.html" class="sidebar-link">内存管理</a></li><li><a href="/iOS知识体系/Block.html" class="active sidebar-link">Block</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/iOS知识体系/Block.html#手写block" class="sidebar-link">手写Block</a></li><li class="sidebar-sub-header"><a href="/iOS知识体系/Block.html#block本质" class="sidebar-link">Block本质</a></li><li class="sidebar-sub-header"><a href="/iOS知识体系/Block.html#block截获变量" class="sidebar-link">Block截获变量</a></li><li class="sidebar-sub-header"><a href="/iOS知识体系/Block.html#block和-weak" class="sidebar-link">_block和_weak</a></li><li class="sidebar-sub-header"><a href="/iOS知识体系/Block.html#block内存管理" class="sidebar-link">Block内存管理</a></li><li class="sidebar-sub-header"><a href="/iOS知识体系/Block.html#block循环引用" class="sidebar-link">Block循环引用</a></li><li class="sidebar-sub-header"><a href="/iOS知识体系/Block.html#block里面self、weakself、strongself使用" class="sidebar-link">Block里面self、weakSelf、strongSelf使用</a></li><li class="sidebar-sub-header"><a href="/iOS知识体系/Block.html#代理和block的区别" class="sidebar-link">代理和block的区别</a></li></ul></li><li><a href="/iOS知识体系/多线程.html" class="sidebar-link">多线程</a></li><li><a href="/iOS知识体系/线程锁.html" class="sidebar-link">线程锁</a></li><li><a href="/iOS知识体系/RunLoop.html" class="sidebar-link">RunLoop</a></li><li><a href="/iOS知识体系/动画.html" class="sidebar-link">动画</a></li><li><a href="/iOS知识体系/数据持久化.html" class="sidebar-link">数据持久化</a></li><li><a href="/iOS知识体系/加密.html" class="sidebar-link">加密</a></li><li><a href="/iOS知识体系/网络.html" class="sidebar-link">网络</a></li><li><a href="/iOS知识体系/设计模式.html" class="sidebar-link">设计模式</a></li><li><a href="/iOS知识体系/架构&amp;框架设计.html" class="sidebar-link">架构&amp;框架设计</a></li><li><a href="/iOS知识体系/第三方库.html" class="sidebar-link">第三方库</a></li><li><a href="/iOS知识体系/ReactNative.html" class="sidebar-link">React Native</a></li><li><a href="/iOS知识体系/算法.html" class="sidebar-link">算法</a></li><li><a href="/iOS知识体系/软件优化.html" class="sidebar-link">软件优化</a></li><li><a href="/iOS知识体系/Git.html" class="sidebar-link">Git</a></li><li><a href="/iOS知识体系/iOS内核.html" class="sidebar-link">iOS内核</a></li><li><a href="/iOS知识体系/视频及音频处理.html" class="sidebar-link">视频及音频处理</a></li><li><a href="/iOS知识体系/直播类软件实现方案.html" class="sidebar-link">直播类软件实现方案</a></li><li><a href="/iOS知识体系/聊天类软件实现方案.html" class="sidebar-link">聊天类软件实现方案</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>iOS笔记</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="block"><a href="#block" class="header-anchor">#</a> Block</h1> <h2 id="手写block"><a href="#手写block" class="header-anchor">#</a> 手写Block</h2> <p>typedef void(^BlockA)(NSData *);<br>
typedef void(^BlockB)(BlockA, NSString *);<br>
typedef void(^BlockC)(void(^)(NSData *), NSString *);
typedef NSString *(^BlockC)(void(^)(NSData *), NSString *);
@property (nonatomic, copy) void(^blockA)(NSData *);<br>
@property (nonatomic, copy) void(^blockB)(void(^)(NSData *), NSString *);<br> <code>- (void)func:(void(^)(NSData *))blockA;</code><br> <code>- (void)func:(void(^)(void(^)(NSData *), NSString *))blockB;</code><br> <code>- (void)func:(BlockA) block;</code><br> <code>- (void)func:(BlockB) block;</code><br>
void(^BlockA)(NSData *) = ^void(NSData *data) {</p> <p>};<br>
void(^BlockB)(void(^)(NSData *), NSString *) = ^void(void(^BlockA)(NSData *data), NSString *str) {</p> <p>};</p> <h2 id="block本质"><a href="#block本质" class="header-anchor">#</a> Block本质</h2> <p>什么是Block？<br>
Block是将函数及其执行上下文封装起来的对象。<br>
什么是Block调用？<br>
Block调用即是函数的调用。</p> <h2 id="block截获变量"><a href="#block截获变量" class="header-anchor">#</a> Block截获变量</h2> <p><img src="/assets/img/Block例子.8e86a37a.png" alt="Block例子">
结果为12<br>
multiplier加上static之后结果为8<br>
multiplier加上__block之后结果为8<br>
Block截获的变量分类：</p> <ul><li>局部变量，又分为基本数据类型和对象类型</li> <li>静态局部变量</li> <li>全局变量</li> <li>静态全局变量</li></ul> <p>1.对于基本类型的局部变量截获其值。<br>
2.对于对象类型的局部变量连同所有权修饰符一起截获。  (weak/strong)<br>
3.以指针形式截获静态局部变量。<br>
4.不截获全局变量和静态全局变量。</p> <h2 id="block和-weak"><a href="#block和-weak" class="header-anchor">#</a> __block和__weak</h2> <p>一般情况下，对被截获变量进行赋值操作需要添加__block修饰符。<br>
对于基本数据类型和对象类型的局部变量需要使用__block进行赋值，对于静态局部变量、全局变量、静态全局变量不需要使用__block修饰符。<br>
__block修饰的变量变成了对象。<br> <img src="/assets/img/__block.0d7b9fd9.png" alt="__block">
__forwarding指针是用来干什么的？</p> <h2 id="block内存管理"><a href="#block内存管理" class="header-anchor">#</a> Block内存管理</h2> <p>Block类型有三种：</p> <ul><li>_NSConcreteGlobalBlock，全局block</li> <li>_NSConcreteStackBlock，栈block</li> <li>_NSConcreteMallocBlock，堆block</li></ul> <p><img src="/assets/img/Block内存.28d95b85.png" alt="Block内存"></p> <p>Block的Copy操作：<br> <img src="/assets/img/Block_Copy.92b14c02.png" alt="Block_Copy">
栈block拷贝之后到了堆，数据区的block拷贝之后什么也不做，堆block拷贝之后增加引用计数。</p> <p>栈上Block的销毁：<br> <img src="/assets/img/栈Block销毁.c03f8e51.png" alt="栈Block销毁">
栈上的__block变量和Block在函数作用域结束后都会进行销毁。</p> <p>栈上Block的Copy：<br> <img src="/assets/img/Block的Copy.f725d609.png" alt="Block的Copy">
栈上的Block进行Copy操作，在MRC上会内存泄漏</p> <p>栈上__block变量的Copy：
<img src="/assets/img/__block变量的Copy.26a60dfd.png" alt="__block变量的Copy"></p> <p>Block为什么使用copy而不使用strong？<br>
block变量是在栈上创建的，为了在作用域之外使用block，需要将它拷贝到堆区，而我们对block使用strong也是可以的，因为block的retain默认是用copy实现的，为了保持属性的使用和声明一致，最好使用copy</p> <p>__forwarding存在的意义<br>
不论在任何内存位置，我们都可以顺利的通过__forwarding访问同一个__block变量</p> <h2 id="block循环引用"><a href="#block循环引用" class="header-anchor">#</a> Block循环引用</h2> <p>__block在MRC下，不会产生循环引用。在ARC下，会产生循环引用，引起内存泄漏。</p> <h2 id="block里面self、weakself、strongself使用"><a href="#block里面self、weakself、strongself使用" class="header-anchor">#</a> Block里面self、weakSelf、strongSelf使用</h2> <p>1.不成环，并且想让block代码什么情况下都执行：两种方式：A.全部使用self就行；B.外面定义weak，block里面用strong，也行，多次一举。</p> <p>2.不成环，并且想让block代码在当前VC释放的情况下不执行：两种方式：A.外面定义weak，里面使用weak，然后注意nil可能会crash的地方（加判断）；B.外面定义weak，block里面使用strong（或者直接使用self），自己加if判断，否是在当前页面，不在当前页面不执行。</p> <p>3.成环，想让block代码无论如何都执行：必用weak。block里面用strong。</p> <p>4.成环，想让block代码在当前VC释放的情况下不执行：两种方式：A.必用weak，block里面用strong，则自己加if判断不在当前页面就不执行；B.block里面使用weak，注意nil可能导致crash的地方。</p> <h2 id="代理和block的区别"><a href="#代理和block的区别" class="header-anchor">#</a> 代理和block的区别</h2> <p>在应用场景上进行比较，block和代理本质上是不同的，因为block其实是一个对象，代理是一种设计模式。</p> <p>block优势：<br>
block代码可读性更好。因为block只要实现就可以了，而代理需要遵守协议并且实现协议里的方法，而两者还不在一个地方。代理使用起来也更麻烦，因为要声明协议、声明代理属性、遵守协议、实现协议里的方法。block不需要声明，也不需要遵守，只需要声明属性和实现就可以了。</p> <p>block是一种轻量级的回调，可以直接访问上下文，由于block的代码时内联的，运行效率更高。block就是一个对象，实现了匿名函数的功能。所以我们可以把block当做一个成员变量、属性、参数使用，使用起来非常灵活。像AFNetworking请求数据和GCD实现多线程，都使用了block回调。</p> <p>block劣势：<br>
block运行成本高。block出栈需要将使用的数据从栈内存拷贝到堆内存，当然对象的话就是引用计数加1，使用完或者block置nil后才销毁。delegate只是保存了一个对象指针，直接回调，没有额外消耗，就像C的函数指针，只多了一个查表操作。<br>
block容易造成循环引用而不以察觉。因为为了block不被系统回收，所以我们都用copy关键字修饰，实行强引用。block对补货的变量也都是强引用，所以就会造成循环引用。</p> <p>如何使用：</p> <ul><li>优先使用block</li> <li>如果回调的状态很多，多余三个使用代理</li> <li>如果回调的很频繁，次数很多，像UITableView，每次初始化、滑动、点击都会回调，使用代理</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/iOS知识体系/内存管理.html" class="prev">
        内存管理
      </a></span> <span class="next"><a href="/iOS知识体系/多线程.html">
        多线程
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.9de76d75.js" defer></script><script src="/assets/js/2.98ea7a63.js" defer></script><script src="/assets/js/9.04a00c43.js" defer></script>
  </body>
</html>
