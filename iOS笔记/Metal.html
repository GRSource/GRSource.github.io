<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Metal | 文档</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/assets/css/0.styles.e4d8b86b.css" as="style"><link rel="preload" href="/assets/js/app.9de76d75.js" as="script"><link rel="preload" href="/assets/js/2.98ea7a63.js" as="script"><link rel="preload" href="/assets/js/52.010a2dfb.js" as="script"><link rel="prefetch" href="/assets/js/10.fa8eed47.js"><link rel="prefetch" href="/assets/js/11.f98f25e0.js"><link rel="prefetch" href="/assets/js/12.1ab9b5a3.js"><link rel="prefetch" href="/assets/js/13.75251b00.js"><link rel="prefetch" href="/assets/js/14.b5068189.js"><link rel="prefetch" href="/assets/js/15.33abd7e1.js"><link rel="prefetch" href="/assets/js/16.34ed8053.js"><link rel="prefetch" href="/assets/js/17.b3d52ea3.js"><link rel="prefetch" href="/assets/js/18.cbe71205.js"><link rel="prefetch" href="/assets/js/19.c632cb86.js"><link rel="prefetch" href="/assets/js/20.90d9a221.js"><link rel="prefetch" href="/assets/js/21.15cb7700.js"><link rel="prefetch" href="/assets/js/22.62ea968a.js"><link rel="prefetch" href="/assets/js/23.b743fdd5.js"><link rel="prefetch" href="/assets/js/24.5d157647.js"><link rel="prefetch" href="/assets/js/25.1935fba3.js"><link rel="prefetch" href="/assets/js/26.fd22f8ee.js"><link rel="prefetch" href="/assets/js/27.f47adfe7.js"><link rel="prefetch" href="/assets/js/28.d9f5719d.js"><link rel="prefetch" href="/assets/js/29.82cbf665.js"><link rel="prefetch" href="/assets/js/3.b96f613e.js"><link rel="prefetch" href="/assets/js/30.9f901f01.js"><link rel="prefetch" href="/assets/js/31.d9e2f61c.js"><link rel="prefetch" href="/assets/js/32.b14052e9.js"><link rel="prefetch" href="/assets/js/33.1b2e5efd.js"><link rel="prefetch" href="/assets/js/34.4bf7f44f.js"><link rel="prefetch" href="/assets/js/35.98d5fd2b.js"><link rel="prefetch" href="/assets/js/36.cdaf1c2f.js"><link rel="prefetch" href="/assets/js/37.a67bdb9a.js"><link rel="prefetch" href="/assets/js/38.5d856b83.js"><link rel="prefetch" href="/assets/js/39.27169c95.js"><link rel="prefetch" href="/assets/js/4.268c621c.js"><link rel="prefetch" href="/assets/js/40.8763c647.js"><link rel="prefetch" href="/assets/js/41.cd839f43.js"><link rel="prefetch" href="/assets/js/42.a97bf97a.js"><link rel="prefetch" href="/assets/js/43.fd126bb1.js"><link rel="prefetch" href="/assets/js/44.50e2b10d.js"><link rel="prefetch" href="/assets/js/45.0c29263b.js"><link rel="prefetch" href="/assets/js/46.fdee27aa.js"><link rel="prefetch" href="/assets/js/47.c7c7e966.js"><link rel="prefetch" href="/assets/js/48.80bc6f0a.js"><link rel="prefetch" href="/assets/js/49.d457b0ac.js"><link rel="prefetch" href="/assets/js/5.f577ebb9.js"><link rel="prefetch" href="/assets/js/50.cea3b0e6.js"><link rel="prefetch" href="/assets/js/51.eaab3e31.js"><link rel="prefetch" href="/assets/js/53.3622f7b6.js"><link rel="prefetch" href="/assets/js/54.817aba2b.js"><link rel="prefetch" href="/assets/js/55.c3984ff9.js"><link rel="prefetch" href="/assets/js/56.6f20785e.js"><link rel="prefetch" href="/assets/js/57.07c7f6fc.js"><link rel="prefetch" href="/assets/js/58.4ec50d24.js"><link rel="prefetch" href="/assets/js/59.626b42b0.js"><link rel="prefetch" href="/assets/js/6.b9249342.js"><link rel="prefetch" href="/assets/js/60.ba2af5c7.js"><link rel="prefetch" href="/assets/js/61.6e22c298.js"><link rel="prefetch" href="/assets/js/62.df85ea27.js"><link rel="prefetch" href="/assets/js/63.cd3c1f6a.js"><link rel="prefetch" href="/assets/js/64.d0f75a86.js"><link rel="prefetch" href="/assets/js/65.12e0c392.js"><link rel="prefetch" href="/assets/js/66.aac422ac.js"><link rel="prefetch" href="/assets/js/67.3ff890c6.js"><link rel="prefetch" href="/assets/js/68.c6d12518.js"><link rel="prefetch" href="/assets/js/69.455e0c09.js"><link rel="prefetch" href="/assets/js/7.375eddd0.js"><link rel="prefetch" href="/assets/js/70.73d975e7.js"><link rel="prefetch" href="/assets/js/71.66528e07.js"><link rel="prefetch" href="/assets/js/72.a608a326.js"><link rel="prefetch" href="/assets/js/73.b8ed0811.js"><link rel="prefetch" href="/assets/js/74.68f4db5d.js"><link rel="prefetch" href="/assets/js/75.85059bdc.js"><link rel="prefetch" href="/assets/js/8.a04b9d9b.js"><link rel="prefetch" href="/assets/js/9.04a00c43.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e4d8b86b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">文档</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>iOS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>iOS笔记</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/iOS笔记/工具.html" class="sidebar-link">工具</a></li><li><a href="/iOS笔记/计算机网络.html" class="sidebar-link">计算机网络</a></li><li><a href="/iOS笔记/架构.html" class="sidebar-link">架构</a></li><li><a href="/iOS笔记/视频播放器设计（基于FFmpeg）.html" class="sidebar-link">视频播放器设计（基于FFmpeg）</a></li><li><a href="/iOS笔记/视频常识.html" class="sidebar-link">视频常识</a></li><li><a href="/iOS笔记/数据结构与算法分析.html" class="sidebar-link">数据结构与算法分析</a></li><li><a href="/iOS笔记/算法.html" class="sidebar-link">算法</a></li><li><a href="/iOS笔记/音频常识.html" class="sidebar-link">音频常识</a></li><li><a href="/iOS笔记/音视频开发.html" class="sidebar-link">音视频开发</a></li><li><a href="/iOS笔记/直播.html" class="sidebar-link">直播</a></li><li><a href="/iOS笔记/App启动优化.html" class="sidebar-link">App启动优化</a></li><li><a href="/iOS笔记/Audio.html" class="sidebar-link">Audio</a></li><li><a href="/iOS笔记/AudioToolbox.html" class="sidebar-link">AudioToolbox</a></li><li><a href="/iOS笔记/AVFoundation.html" class="sidebar-link">AVFoundation</a></li><li><a href="/iOS笔记/C.html#.html" class="sidebar-link">C</a></li><li><a href="/iOS笔记/C.html#.html" class="sidebar-link">C#</a></li><li><a href="/iOS笔记/C++.html" class="sidebar-link">C++</a></li><li><a href="/iOS笔记/CoreAudio.html" class="sidebar-link">CoreAudio</a></li><li><a href="/iOS笔记/CoreVideo.html" class="sidebar-link">CoreVideo</a></li><li><a href="/iOS笔记/FFmpeg.html" class="sidebar-link">FFmpeg</a></li><li><a href="/iOS笔记/Flutter.html" class="sidebar-link">Flutter</a></li><li><a href="/iOS笔记/GPUImage.html" class="sidebar-link">GPUImage</a></li><li><a href="/iOS笔记/ijkPlayer.html" class="sidebar-link">ijkPlayer</a></li><li><a href="/iOS笔记/iOS细节.html" class="sidebar-link">iOS细节</a></li><li><a href="/iOS笔记/iOS性能优化.html" class="sidebar-link">iOS性能优化</a></li><li><a href="/iOS笔记/LFLiveKit.html" class="sidebar-link">LFLiveKit</a></li><li><a href="/iOS笔记/Metal.html" class="active sidebar-link">Metal</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/iOS笔记/Metal.html#cametallayer" class="sidebar-link">CAMetalLayer</a></li><li class="sidebar-sub-header"><a href="/iOS笔记/Metal.html#mtlrendercommandencoder" class="sidebar-link">MTLRenderCommandEncoder</a></li><li class="sidebar-sub-header"><a href="/iOS笔记/Metal.html#mtlrenderpassdescriptor" class="sidebar-link">MTLRenderPassDescriptor</a></li><li class="sidebar-sub-header"><a href="/iOS笔记/Metal.html#framebuffer" class="sidebar-link">framebuffer</a></li><li class="sidebar-sub-header"><a href="/iOS笔记/Metal.html#mtlbuffer" class="sidebar-link">MTLBuffer</a></li><li class="sidebar-sub-header"><a href="/iOS笔记/Metal.html#shaders-metal" class="sidebar-link">Shaders.metal</a></li><li class="sidebar-sub-header"><a href="/iOS笔记/Metal.html#mtlrenderpipelinestate" class="sidebar-link">MTLRenderPipelineState</a></li><li class="sidebar-sub-header"><a href="/iOS笔记/Metal.html#mtlrenderpipelinedescriptor" class="sidebar-link">MTLRenderPipelineDescriptor</a></li><li class="sidebar-sub-header"><a href="/iOS笔记/Metal.html#流程" class="sidebar-link">流程</a></li><li class="sidebar-sub-header"><a href="/iOS笔记/Metal.html#mtllibrary" class="sidebar-link">MTLLibrary</a></li><li class="sidebar-sub-header"><a href="/iOS笔记/Metal.html#opengl的原点在左下角-而metal的原点在左上角" class="sidebar-link">OpenGL的原点在左下角，而Metal的原点在左上角</a></li></ul></li><li><a href="/iOS笔记/Objective-C.html" class="sidebar-link">Objective-C</a></li><li><a href="/iOS笔记/OpenGL相关概念.html" class="sidebar-link">OpenGL相关概念</a></li><li><a href="/iOS笔记/pthread.html" class="sidebar-link">pthread</a></li><li><a href="/iOS笔记/ReactNative.html" class="sidebar-link">React Native</a></li><li><a href="/iOS笔记/RunLoop.html" class="sidebar-link">RunLoop</a></li><li><a href="/iOS笔记/UI视图.html" class="sidebar-link">UI视图</a></li><li><a href="/iOS笔记/VideoToolbox.html" class="sidebar-link">VideoToolbox</a></li><li><a href="/iOS笔记/WebAssembly.html" class="sidebar-link">WebAssembly</a></li><li><a href="/iOS笔记/WebRTC.html" class="sidebar-link">WebRTC</a></li><li><a href="/iOS笔记/第三方.html" class="sidebar-link">第三方</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="metal"><a href="#metal" class="header-anchor">#</a> Metal</h1> <h2 id="cametallayer"><a href="#cametallayer" class="header-anchor">#</a> CAMetalLayer</h2> <h3 id="pixelformat"><a href="#pixelformat" class="header-anchor">#</a> pixelFormat</h3> <ul><li><p>.bgra8Unorm</p> <p>每个像素由蓝、绿、红、alpha分量组成，每个分量是一个8位无符号整数(0-255)</p></li></ul> <h3 id="mtldevice"><a href="#mtldevice" class="header-anchor">#</a> MTLDevice</h3> <ul><li><p>MTLCommandQueue</p> <p>保存了一系列要执行的命令缓存，长期持有，不用每次都创建</p> <ul><li><p>MTLCommandBuffer</p> <p>表示一个渲染命令的集合单元</p> <ul><li>一切设置完之后commandBuffer.commit</li></ul></li></ul></li> <li><p>render states</p></li> <li><p>MTLLibrary</p> <p>makeDefaultLibrary，参数为shader所在的bundle</p></li></ul> <h3 id="cametaldrawable"><a href="#cametaldrawable" class="header-anchor">#</a> CAMetalDrawable</h3> <p>从layer当中取出下一个空画板(drawable)，然后取出对应的可绘制的texture属性赋给渲染描述符Descriptor，用于绘制</p> <ul><li><p>MTLTexture</p> <p>单个纹理可以对应一组图像</p></li></ul> <h2 id="mtlrendercommandencoder"><a href="#mtlrendercommandencoder" class="header-anchor">#</a> MTLRenderCommandEncoder</h2> <p>通过commandBuffer?.makeRenderCommandEncoder获得，负责将高级指令转换成底层指令（设置着色器参数、绘制三角形等等），然后将这些指令写入commandBuffer，完成之后设置endEncoding。encoder是配置跟程序相关的一些设置</p> <h2 id="mtlrenderpassdescriptor"><a href="#mtlrenderpassdescriptor" class="header-anchor">#</a> MTLRenderPassDescriptor</h2> <p>告诉Metal在渲染图像时要执行哪些操作。里面进行一些一些跟程序无关的系统设置</p> <h3 id="mtlrenderpasscolorattachmentdescriptor"><a href="#mtlrenderpasscolorattachmentdescriptor" class="header-anchor">#</a> MTLRenderPassColorAttachmentDescriptor</h3> <ul><li><p>loadAction</p> <p>决定每次渲染是否清除或者保留之前的内容</p> <ul><li>.clear</li> <li>.dontCare</li> <li>.load</li></ul></li> <li><p>storeAction</p> <p>决定渲染对纹理的影响：结果是被存储还是丢弃，因为我们希望我们的像素最终出现在屏幕上，所以我们选择.store</p></li> <li><p>clearColor</p> <p>绘制之前显示的颜色，也就是清理后的背景色</p></li> <li><p>texture</p> <p>回调的texture（即空画板）</p></li></ul> <h2 id="framebuffer"><a href="#framebuffer" class="header-anchor">#</a> framebuffer</h2> <p>像素被写入的地方</p> <h2 id="mtlbuffer"><a href="#mtlbuffer" class="header-anchor">#</a> MTLBuffer</h2> <p>与设备相关的缓冲区，由设备管理，用来存储数据，所以需要由设备创建device.makeBuffer，可以创建顶点、颜色、纹理等坐标缓存，用于commandEncoder</p> <h2 id="shaders-metal"><a href="#shaders-metal" class="header-anchor">#</a> Shaders.metal</h2> <h3 id="vertex-coloredvertex-vertex-main-constant-float4-position-buffer-0"><a href="#vertex-coloredvertex-vertex-main-constant-float4-position-buffer-0" class="header-anchor">#</a> vertex ColoredVertex vertex_main(constant float4 *position[[buffer(0)]],</h3> <div class="language- extra-class"><pre><code>                                                         constant float4 *color[[buffer(1)]],
                             uint vid[[vertex_id]])
</code></pre></div><p>{
ColoredVertex vert;
vert.position = position[vid];
vert.color = color[vid];
return vert;
}</p> <p>fragment float4 fragment_main(ColoredVertex vert[[stage_in]])
{
return vert.color;
}</p> <ul><li>顶点着色器是微观着色程序，片元着色器是宏观着色程序</li> <li>buffer(0)和buffer(1)对应encoder创建时设置的索引</li> <li>vid对应当前顶点，从0-2运行（对于三角形中每个点运行一次）</li> <li>片元着色器中的参数vert和顶点着色器中返回vert并不是一一对应的关系，因为顶点着色器可能只会调用三次来绘制我们的三角形，而片元着色器可能会调用数千次，所以[[stage_in]]限定符是用来取的每个fragment数据</li> <li>fragment中的的vert是在光栅化阶段构造。光栅化决定了哪些像素被我们绘制的三角形覆盖，同时采用顶点之间插值的方式生成新的vert，以传递给片元着色器。</li></ul> <h2 id="mtlrenderpipelinestate"><a href="#mtlrenderpipelinestate" class="header-anchor">#</a> MTLRenderPipelineState</h2> <p>渲染管线状态对象，封装了已经编译和链接的着色器程序（顶点着色器、片元着色器等），开销比较大，所以我们应该仅仅只为着色程序创建一个管线状态对象。</p> <h2 id="mtlrenderpipelinedescriptor"><a href="#mtlrenderpipelinedescriptor" class="header-anchor">#</a> MTLRenderPipelineDescriptor</h2> <p>渲染管线描述符，用来配置顶点函数、片元函数等</p> <h3 id="vertexfunction"><a href="#vertexfunction" class="header-anchor">#</a> vertexFunction</h3> <h3 id="fragmentfunction"><a href="#fragmentfunction" class="header-anchor">#</a> fragmentFunction</h3> <h3 id="colorattachments-0"><a href="#colorattachments-0" class="header-anchor">#</a> colorAttachments[0]</h3> <p>颜色附件0通常用作渲染到屏幕的帧缓冲区，所以layer的pixelFormat和colorAttachments[0]的pixelFormat</p> <h2 id="流程"><a href="#流程" class="header-anchor">#</a> 流程</h2> <h3 id="创建device添加到layer当中"><a href="#创建device添加到layer当中" class="header-anchor">#</a> 创建device添加到layer当中</h3> <h3 id="通过device创建position和color的mtlbuffer-后面添加到commandencoder当中"><a href="#通过device创建position和color的mtlbuffer-后面添加到commandencoder当中" class="header-anchor">#</a> 通过device创建position和color的MTLBuffer，后面添加到commandEncoder当中</h3> <h3 id="通过device创建commandqueue"><a href="#通过device创建commandqueue" class="header-anchor">#</a> 通过device创建commandQueue</h3> <h3 id="通过commandqueue创建commandbuffer"><a href="#通过commandqueue创建commandbuffer" class="header-anchor">#</a> 通过commandQueue创建commandBuffer</h3> <h3 id="创建renderpassdescriptor"><a href="#创建renderpassdescriptor" class="header-anchor">#</a> 创建renderpassDescriptor</h3> <h3 id="通过commandbuffer和renderpassdescriptor创建commandencoder"><a href="#通过commandbuffer和renderpassdescriptor创建commandencoder" class="header-anchor">#</a> 通过commandBuffer和renderpassDescriptor创建commandEncoder</h3> <h3 id="为commandencoder配置mtlbuffer"><a href="#为commandencoder配置mtlbuffer" class="header-anchor">#</a> 为commandEncoder配置MTLBuffer</h3> <h3 id="commandbuffer-commit"><a href="#commandbuffer-commit" class="header-anchor">#</a> commandBuffer.commit</h3> <h3 id="通过device创建library-通过library创建着色函数-着色器"><a href="#通过device创建library-通过library创建着色函数-着色器" class="header-anchor">#</a> 通过device创建library，通过library创建着色函数（着色器）</h3> <h3 id="创建管线描述符renderpipelinedescriptor-并将着色函数运用于管线描述符"><a href="#创建管线描述符renderpipelinedescriptor-并将着色函数运用于管线描述符" class="header-anchor">#</a> 创建管线描述符renderpipelineDescriptor，并将着色函数运用于管线描述符</h3> <h3 id="通过device和管线描述符创建mtlrenderpipelinestate"><a href="#通过device和管线描述符创建mtlrenderpipelinestate" class="header-anchor">#</a> 通过device和管线描述符创建MTLRenderPipelineState</h3> <h3 id="将piplinestate运用于commandencoder"><a href="#将piplinestate运用于commandencoder" class="header-anchor">#</a> 将piplineState运用于commandEncoder</h3> <h2 id="mtllibrary"><a href="#mtllibrary" class="header-anchor">#</a> MTLLibrary</h2> <p>运用于着色程序的库</p> <h2 id="opengl的原点在左下角-而metal的原点在左上角"><a href="#opengl的原点在左下角-而metal的原点在左上角" class="header-anchor">#</a> OpenGL的原点在左下角，而Metal的原点在左上角</h2> <p><em>XMind - Trial Version</em></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/iOS笔记/LFLiveKit.html" class="prev">
        LFLiveKit
      </a></span> <span class="next"><a href="/iOS笔记/Objective-C.html">
        Objective-C
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.9de76d75.js" defer></script><script src="/assets/js/2.98ea7a63.js" defer></script><script src="/assets/js/52.010a2dfb.js" defer></script>
  </body>
</html>
