<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>LFLiveKit | 文档</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/assets/css/0.styles.e4d8b86b.css" as="style"><link rel="preload" href="/assets/js/app.9de76d75.js" as="script"><link rel="preload" href="/assets/js/2.98ea7a63.js" as="script"><link rel="preload" href="/assets/js/51.eaab3e31.js" as="script"><link rel="prefetch" href="/assets/js/10.fa8eed47.js"><link rel="prefetch" href="/assets/js/11.f98f25e0.js"><link rel="prefetch" href="/assets/js/12.1ab9b5a3.js"><link rel="prefetch" href="/assets/js/13.75251b00.js"><link rel="prefetch" href="/assets/js/14.b5068189.js"><link rel="prefetch" href="/assets/js/15.33abd7e1.js"><link rel="prefetch" href="/assets/js/16.34ed8053.js"><link rel="prefetch" href="/assets/js/17.b3d52ea3.js"><link rel="prefetch" href="/assets/js/18.cbe71205.js"><link rel="prefetch" href="/assets/js/19.c632cb86.js"><link rel="prefetch" href="/assets/js/20.90d9a221.js"><link rel="prefetch" href="/assets/js/21.15cb7700.js"><link rel="prefetch" href="/assets/js/22.62ea968a.js"><link rel="prefetch" href="/assets/js/23.b743fdd5.js"><link rel="prefetch" href="/assets/js/24.5d157647.js"><link rel="prefetch" href="/assets/js/25.1935fba3.js"><link rel="prefetch" href="/assets/js/26.fd22f8ee.js"><link rel="prefetch" href="/assets/js/27.f47adfe7.js"><link rel="prefetch" href="/assets/js/28.d9f5719d.js"><link rel="prefetch" href="/assets/js/29.82cbf665.js"><link rel="prefetch" href="/assets/js/3.b96f613e.js"><link rel="prefetch" href="/assets/js/30.9f901f01.js"><link rel="prefetch" href="/assets/js/31.d9e2f61c.js"><link rel="prefetch" href="/assets/js/32.b14052e9.js"><link rel="prefetch" href="/assets/js/33.1b2e5efd.js"><link rel="prefetch" href="/assets/js/34.4bf7f44f.js"><link rel="prefetch" href="/assets/js/35.98d5fd2b.js"><link rel="prefetch" href="/assets/js/36.cdaf1c2f.js"><link rel="prefetch" href="/assets/js/37.a67bdb9a.js"><link rel="prefetch" href="/assets/js/38.5d856b83.js"><link rel="prefetch" href="/assets/js/39.27169c95.js"><link rel="prefetch" href="/assets/js/4.268c621c.js"><link rel="prefetch" href="/assets/js/40.8763c647.js"><link rel="prefetch" href="/assets/js/41.cd839f43.js"><link rel="prefetch" href="/assets/js/42.a97bf97a.js"><link rel="prefetch" href="/assets/js/43.fd126bb1.js"><link rel="prefetch" href="/assets/js/44.50e2b10d.js"><link rel="prefetch" href="/assets/js/45.0c29263b.js"><link rel="prefetch" href="/assets/js/46.fdee27aa.js"><link rel="prefetch" href="/assets/js/47.c7c7e966.js"><link rel="prefetch" href="/assets/js/48.80bc6f0a.js"><link rel="prefetch" href="/assets/js/49.d457b0ac.js"><link rel="prefetch" href="/assets/js/5.f577ebb9.js"><link rel="prefetch" href="/assets/js/50.cea3b0e6.js"><link rel="prefetch" href="/assets/js/52.010a2dfb.js"><link rel="prefetch" href="/assets/js/53.3622f7b6.js"><link rel="prefetch" href="/assets/js/54.817aba2b.js"><link rel="prefetch" href="/assets/js/55.c3984ff9.js"><link rel="prefetch" href="/assets/js/56.6f20785e.js"><link rel="prefetch" href="/assets/js/57.07c7f6fc.js"><link rel="prefetch" href="/assets/js/58.4ec50d24.js"><link rel="prefetch" href="/assets/js/59.626b42b0.js"><link rel="prefetch" href="/assets/js/6.b9249342.js"><link rel="prefetch" href="/assets/js/60.ba2af5c7.js"><link rel="prefetch" href="/assets/js/61.6e22c298.js"><link rel="prefetch" href="/assets/js/62.df85ea27.js"><link rel="prefetch" href="/assets/js/63.cd3c1f6a.js"><link rel="prefetch" href="/assets/js/64.d0f75a86.js"><link rel="prefetch" href="/assets/js/65.12e0c392.js"><link rel="prefetch" href="/assets/js/66.aac422ac.js"><link rel="prefetch" href="/assets/js/67.3ff890c6.js"><link rel="prefetch" href="/assets/js/68.c6d12518.js"><link rel="prefetch" href="/assets/js/69.455e0c09.js"><link rel="prefetch" href="/assets/js/7.375eddd0.js"><link rel="prefetch" href="/assets/js/70.73d975e7.js"><link rel="prefetch" href="/assets/js/71.66528e07.js"><link rel="prefetch" href="/assets/js/72.a608a326.js"><link rel="prefetch" href="/assets/js/73.b8ed0811.js"><link rel="prefetch" href="/assets/js/74.68f4db5d.js"><link rel="prefetch" href="/assets/js/75.85059bdc.js"><link rel="prefetch" href="/assets/js/8.a04b9d9b.js"><link rel="prefetch" href="/assets/js/9.04a00c43.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e4d8b86b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">文档</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>iOS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>iOS笔记</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/iOS笔记/工具.html" class="sidebar-link">工具</a></li><li><a href="/iOS笔记/计算机网络.html" class="sidebar-link">计算机网络</a></li><li><a href="/iOS笔记/架构.html" class="sidebar-link">架构</a></li><li><a href="/iOS笔记/视频播放器设计（基于FFmpeg）.html" class="sidebar-link">视频播放器设计（基于FFmpeg）</a></li><li><a href="/iOS笔记/视频常识.html" class="sidebar-link">视频常识</a></li><li><a href="/iOS笔记/数据结构与算法分析.html" class="sidebar-link">数据结构与算法分析</a></li><li><a href="/iOS笔记/算法.html" class="sidebar-link">算法</a></li><li><a href="/iOS笔记/音频常识.html" class="sidebar-link">音频常识</a></li><li><a href="/iOS笔记/音视频开发.html" class="sidebar-link">音视频开发</a></li><li><a href="/iOS笔记/直播.html" class="sidebar-link">直播</a></li><li><a href="/iOS笔记/App启动优化.html" class="sidebar-link">App启动优化</a></li><li><a href="/iOS笔记/Audio.html" class="sidebar-link">Audio</a></li><li><a href="/iOS笔记/AudioToolbox.html" class="sidebar-link">AudioToolbox</a></li><li><a href="/iOS笔记/AVFoundation.html" class="sidebar-link">AVFoundation</a></li><li><a href="/iOS笔记/C.html#.html" class="sidebar-link">C</a></li><li><a href="/iOS笔记/C.html#.html" class="sidebar-link">C#</a></li><li><a href="/iOS笔记/C++.html" class="sidebar-link">C++</a></li><li><a href="/iOS笔记/CoreAudio.html" class="sidebar-link">CoreAudio</a></li><li><a href="/iOS笔记/CoreVideo.html" class="sidebar-link">CoreVideo</a></li><li><a href="/iOS笔记/FFmpeg.html" class="sidebar-link">FFmpeg</a></li><li><a href="/iOS笔记/Flutter.html" class="sidebar-link">Flutter</a></li><li><a href="/iOS笔记/GPUImage.html" class="sidebar-link">GPUImage</a></li><li><a href="/iOS笔记/ijkPlayer.html" class="sidebar-link">ijkPlayer</a></li><li><a href="/iOS笔记/iOS细节.html" class="sidebar-link">iOS细节</a></li><li><a href="/iOS笔记/iOS性能优化.html" class="sidebar-link">iOS性能优化</a></li><li><a href="/iOS笔记/LFLiveKit.html" class="active sidebar-link">LFLiveKit</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/iOS笔记/LFLiveKit.html#nginx服务器" class="sidebar-link">nginx服务器</a></li><li class="sidebar-sub-header"><a href="/iOS笔记/LFLiveKit.html#rtmp协议" class="sidebar-link">rtmp协议</a></li><li class="sidebar-sub-header"><a href="/iOS笔记/LFLiveKit.html#gpuimage" class="sidebar-link">GPUImage</a></li><li class="sidebar-sub-header"><a href="/iOS笔记/LFLiveKit.html#结构属性" class="sidebar-link">结构属性</a></li><li class="sidebar-sub-header"><a href="/iOS笔记/LFLiveKit.html#ffmpeg可以推流" class="sidebar-link">ffmpeg可以推流</a></li></ul></li><li><a href="/iOS笔记/Metal.html" class="sidebar-link">Metal</a></li><li><a href="/iOS笔记/Objective-C.html" class="sidebar-link">Objective-C</a></li><li><a href="/iOS笔记/OpenGL相关概念.html" class="sidebar-link">OpenGL相关概念</a></li><li><a href="/iOS笔记/pthread.html" class="sidebar-link">pthread</a></li><li><a href="/iOS笔记/ReactNative.html" class="sidebar-link">React Native</a></li><li><a href="/iOS笔记/RunLoop.html" class="sidebar-link">RunLoop</a></li><li><a href="/iOS笔记/UI视图.html" class="sidebar-link">UI视图</a></li><li><a href="/iOS笔记/VideoToolbox.html" class="sidebar-link">VideoToolbox</a></li><li><a href="/iOS笔记/WebAssembly.html" class="sidebar-link">WebAssembly</a></li><li><a href="/iOS笔记/WebRTC.html" class="sidebar-link">WebRTC</a></li><li><a href="/iOS笔记/第三方.html" class="sidebar-link">第三方</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="lflivekit"><a href="#lflivekit" class="header-anchor">#</a> LFLiveKit</h1> <h2 id="nginx服务器"><a href="#nginx服务器" class="header-anchor">#</a> nginx服务器</h2> <h3 id="配置nginx-conf"><a href="#配置nginx-conf" class="header-anchor">#</a> 配置nginx.conf</h3> <h3 id="端口号1935"><a href="#端口号1935" class="header-anchor">#</a> 端口号1935</h3> <h2 id="rtmp协议"><a href="#rtmp协议" class="header-anchor">#</a> rtmp协议</h2> <h2 id="gpuimage"><a href="#gpuimage" class="header-anchor">#</a> GPUImage</h2> <h3 id="视频采集"><a href="#视频采集" class="header-anchor">#</a> 视频采集</h3> <h3 id="滤镜"><a href="#滤镜" class="header-anchor">#</a> 滤镜</h3> <h2 id="结构属性"><a href="#结构属性" class="header-anchor">#</a> 结构属性</h2> <h3 id="lflivestreaminfo"><a href="#lflivestreaminfo" class="header-anchor">#</a> LFLiveStreamInfo</h3> <p>用于声明流信息的类，作用类似于model单纯的存储信息。用户可以通过这个类设置去音视频的具体参数，其中包含视频的音视频的相关设置等</p> <ul><li><p>NSString *streamId;</p></li> <li><p>NSString *host;</p></li> <li><p>NSInteger port;</p></li> <li><p>url</p></li> <li><p>LFLiveAudioConfiguration *audioConfiguration;</p> <ul><li><p>NSUInteger numberOfChannels;</p> <p>声道数目，default 2</p></li> <li><p>LFLiveAudioSampleRate audioSampleRate;</p> <p>采样率</p> <ul><li><p>LFLiveAudioSampleRate_16000Hz</p></li> <li><p>LFLiveAudioSampleRate_44100Hz</p> <ul><li>default</li></ul></li> <li><p>LFLiveAudioSampleRate_48000Hz</p></li></ul></li> <li><p>LFLiveAudioBitRate audioBitrate;</p> <p>码率</p> <ul><li><p>LFLiveAudioBitRate_32Kbps</p></li> <li><p>LFLiveAudioBitRate_64Kbps</p></li> <li><p>LFLiveAudioBitRate_96Kbps</p> <ul><li>default</li></ul></li> <li><p>LFLiveAudioBitRate_128Kbps</p></li></ul></li> <li><p>char *asc;</p> <p>flv编码音频头 44100 为0x12 0x10</p></li> <li><p>NSUInteger bufferLength;</p> <p>缓存区长度</p></li></ul></li> <li><p>LFLiveVideoConfiguration *videoConfiguration;</p> <ul><li><p>CGSize videoSize;</p> <p>视频的分辨率，宽高务必设定为 2 的倍数，否则解码播放时可能出现绿边(这个videoSizeRespectingAspectRatio设置为YES则可能会改变)</p></li> <li><p>videoSizeRespectingAspectRatio</p> <p>输出图像是否等比例,默认为NO</p></li> <li><p>UIInterfaceOrientation outputImageOrientation;</p> <p>视频输出方向</p></li> <li><p>BOOL autorotate;</p> <p>自动旋转(这里只支持 left 变 right  portrait 变 portraitUpsideDown)</p></li> <li><p>NSUInteger videoFrameRate;</p> <p>视频的帧率，即 fps，一般24、25、30</p></li> <li><p>NSUInteger videoMaxFrameRate;</p> <p>视频的最大帧率，即 fps</p></li> <li><p>NSUInteger videoMinFrameRate;</p> <p>视频的最小帧率，即 fps</p></li> <li><p>NSUInteger videoMaxKeyframeInterval;</p> <p>最大关键帧间隔，可设定为 fps 的2倍，影响一个 gop 的大小，也就是最多2秒显示一个关键帧</p></li> <li><p>NSUInteger videoBitRate;</p> <p>视频的码率，单位是 bps</p></li> <li><p>NSUInteger videoMaxBitRate;</p> <p>视频的最大码率，单位是 bps</p></li> <li><p>NSUInteger videoMinBitRate;</p> <p>视频的最小码率，单位是 bps</p></li> <li><p>LFLiveVideoSessionPreset sessionPreset;</p> <p>分辨率</p> <ul><li><p>LFCaptureSessionPreset360x640</p> <p>低分辨率</p></li> <li><p>LFCaptureSessionPreset540x960</p> <p>中分辨率</p></li> <li><p>LFCaptureSessionPreset720x1280</p> <p>高分辨率</p> <ul><li>default</li></ul></li></ul></li> <li><p>NSString *avSessionPreset;</p> <p>&lt; ≈sde3分辨率</p></li> <li><p>BOOL landscape;</p> <p>&lt; 是否是横屏</p></li></ul></li></ul> <h3 id="lflivesession"><a href="#lflivesession" class="header-anchor">#</a> LFLiveSession</h3> <ul><li><p>BOOL running;</p> <p>是否开始采集视频</p></li> <li><p>UIView *preView;</p> <p>用于显示的view</p></li> <li><ul><li>(void)startLive:</li></ul> <p>开始直播</p></li> <li><ul><li>(void)stopLive</li></ul> <p>停止直播</p></li> <li><p>LFVideoCapture *videoCaptureSource;视频采集类</p> <ul><li><p>最终调用GPUImage里面的GPUImageVideoCamera类的startCameraCapture方法进行采集</p> <ul><li><p>通过打印发现GPUImage采集到的CVPixelBufferRef，其pixelFormatType为BGRA，它的颜色空间为BGRA，其在内存中的顺序是BGRABGRA...，所以是kCVPixelFormatType_32BGRA类型？并不是，采集是420f，内部通过一次转换，最后用户发现是RGB类型</p> <ul><li>对数据进行硬编码LFHardwareVideoEncoder类</li></ul></li></ul></li></ul></li> <li><p>LFAudioCapture *audioCaptureSource;音频采集类</p> <ul><li><p>最终使用AudioToolbox中的AudioOutputUnitStart进行采集</p> <ul><li>对采集的数据进行编码LFHardwareAudioEncoder</li></ul></li></ul></li> <li><p>LFHardwareAudioEncoder音频编码类</p> <p>使用系统AudioToolbox进行硬编码</p> <ul><li><p>初始化编码器</p> <ul><li><p>初始化输入流描述符</p> <ul><li><div class="language- extra-class"><pre><code>AudioStreamBasicDescription inputFormat = {0};
</code></pre></div></li></ul></li></ul></li></ul> <p>inputFormat.mSampleRate = _configuration.audioSampleRate;
inputFormat.mFormatID = kAudioFormatLinearPCM;
inputFormat.mFormatFlags = kAudioFormatFlagIsSignedInteger | kAudioFormatFlagsNativeEndian | kAudioFormatFlagIsPacked;
inputFormat.mChannelsPerFrame = (UInt32)_configuration.numberOfChannels;
inputFormat.mFramesPerPacket = 1;
inputFormat.mBitsPerChannel = 16;
inputFormat.mBytesPerFrame = inputFormat.mBitsPerChannel / 8 * inputFormat.mChannelsPerFrame;
inputFormat.mBytesPerPacket = inputFormat.mBytesPerFrame * inputFormat.mFramesPerPacket;</p> <div class="language- extra-class"><pre><code>  - 初始化输出流描述符

  	-     AudioStreamBasicDescription outputFormat; // 这里开始是输出音频格式
</code></pre></div><p>memset(&amp;outputFormat, 0, sizeof(outputFormat));
outputFormat.mSampleRate = inputFormat.mSampleRate;       // 采样率保持一致
outputFormat.mFormatID = kAudioFormatMPEG4AAC;            // AAC编码 kAudioFormatMPEG4AAC kAudioFormatMPEG4AAC_HE_V2
outputFormat.mChannelsPerFrame = (UInt32)_configuration.numberOfChannels;;
outputFormat.mFramesPerPacket = 1024;                     // AAC一帧是1024个字节</p></li> <li><p>iOS8.0及以上LFHardwareVideoEncoder视频硬编码类，iOS8以下采用软编码</p> <ul><li><p>初始化编码器</p> <ul><li><p>OSStatus status = VTCompressionSessionCreate(NULL, _configuration.videoSize.width, _configuration.videoSize.height, kCMVideoCodecType_H264, NULL, NULL, NULL, VideoCompressonOutputCallback, (__bridge void *)self, &amp;compressionSession);</p> <ul><li><p>设置编码属性</p> <ul><li><div class="language- extra-class"><pre><code>VTSessionSetProperty(compressionSession, kVTCompressionPropertyKey_MaxKeyFrameInterval, (__bridge CFTypeRef)@(_configuration.videoMaxKeyframeInterval));
</code></pre></div></li></ul></li></ul></li></ul></li></ul> <p>VTSessionSetProperty(compressionSession, kVTCompressionPropertyKey_MaxKeyFrameIntervalDuration, (__bridge CFTypeRef)@(_configuration.videoMaxKeyframeInterval/_configuration.videoFrameRate));
VTSessionSetProperty(compressionSession, kVTCompressionPropertyKey_ExpectedFrameRate, (__bridge CFTypeRef)@(_configuration.videoFrameRate));
VTSessionSetProperty(compressionSession, kVTCompressionPropertyKey_AverageBitRate, (__bridge CFTypeRef)@(_configuration.videoBitRate));
NSArray *limit = @[@(_configuration.videoBitRate * 1.5/8), @(1)];
VTSessionSetProperty(compressionSession, kVTCompressionPropertyKey_DataRateLimits, (__bridge CFArrayRef)limit);
VTSessionSetProperty(compressionSession, kVTCompressionPropertyKey_RealTime, kCFBooleanTrue);
VTSessionSetProperty(compressionSession, kVTCompressionPropertyKey_ProfileLevel, kVTProfileLevel_H264_Main_AutoLevel);
VTSessionSetProperty(compressionSession, kVTCompressionPropertyKey_AllowFrameReordering, kCFBooleanTrue);
VTSessionSetProperty(compressionSession, kVTCompressionPropertyKey_H264EntropyMode, kVTH264EntropyMode_CABAC);</p> <div class="language- extra-class"><pre><code>  			- 准备编码

  				- VTCompressionSessionPrepareToEncodeFrames(compressionSession);

  					- 输入待编码的数据

  						- OSStatus status = VTCompressionSessionEncodeFrame(compressionSession, pixelBuffer, presentationTimeStamp, duration, (__bridge CFDictionaryRef)properties, (__bridge_retained void *)timeNumber, &amp;flags);

  						  就是向编码器中传入pixelBuffer

  							- 获取编码后的数据

  							  通过初始化时的回调函数VideoCompressonOutputCallback获取编码后的数据，如果这一帧是关键帧，那么我们需要获取SPS和PPS数据，然后给这些数据加上开始码返回出去。

  								- 判断是否是关键帧

  									- 是

  										- 获取pps和sps

  											- CMFormatDescriptionRef format = CMSampleBufferGetFormatDescription(sampleBuffer);       OSStatus statusCode = CMVideoFormatDescriptionGetH264ParameterSetAtIndex(format, 0, &amp;sparameterSet, &amp;sparameterSetSize, &amp;sparameterSetCount, 0);    OSStatus statusCode = CMVideoFormatDescriptionGetH264ParameterSetAtIndex(format, 1, &amp;pparameterSet, &amp;pparameterSetSize, &amp;pparameterSetCount, 0);

  												- 获取到sps和pps后，获取帧数据

  													-     CMBlockBufferRef dataBuffer = CMSampleBufferGetDataBuffer(sampleBuffer);
</code></pre></div><p>size_t length, totalLength;
char *dataPointer;
OSStatus statusCodeRet = CMBlockBufferGetDataPointer(dataBuffer, 0, &amp;length, &amp;totalLength, &amp;dataPointer);</p> <div class="language- extra-class"><pre><code>  														- 读取NAL Unit长度

  															-             uint32_t NALUnitLength = 0;
      memcpy(&amp;NALUnitLength, dataPointer + bufferOffset, AVCCHeaderLength);

      NALUnitLength = CFSwapInt32BigToHost(NALUnitLength);//大端转小端

  																- 组装成LFVideoFrame

  																  里面包含了时间戳、帧数据、sps、pps字段

  																	- 通过LFStreamRTMPSocket发送音频流

  									- 否
</code></pre></div></li> <li><p>LFStreamRTMPSocket数据发送类</p> <p>对pili-librtmp的封装</p> <ul><li><p>开始直播时，建立连接通道</p> <ul><li><p>分配与初始化rtmp</p> <ul><li><p>_rtmp = PILI_RTMP_Alloc();
PILI_RTMP_Init(_rtmp);</p> <ul><li><p>设置url</p> <ul><li><p>子主题 1</p> <ul><li><p>PILI_RTMP_SetupURL(_rtmp, push_url, &amp;_error)</p> <ul><li><p>设置错误回调、连接回调函数</p> <ul><li><p>_rtmp-&gt;m_errorCallback = RTMPErrorCallback;
_rtmp-&gt;m_connCallback = ConnectionTimeCallback;
_rtmp-&gt;m_userData = (__bridge void *)self;
_rtmp-&gt;m_msgCounter = 1;
_rtmp-&gt;Link.timeout = RTMP_RECEIVE_TIMEOUT;</p> <ul><li><p>//设置可写，即发布流，这个函数必须在连接前使用，否则无效
PILI_RTMP_EnableWrite(_rtmp);</p> <ul><li><p>//连接服务器
if (PILI_RTMP_Connect(_rtmp, NULL, &amp;_error) == FALSE) {
goto Failed;
}</p> <ul><li><p>//连接流
if (PILI_RTMP_ConnectStream(_rtmp, 0, &amp;_error) == FALSE) {
goto Failed;
}</p> <ul><li><p>连接成功后发送一个参数包，里面包含了一系列参数，方便后面数据的解析</p> <ul><li><p>初始化完成后开始发送数据</p> <ul><li><p>对需要发送的LFAudioFrame和LFVideoFrame数据进行缓存，根据时间戳进行排序，缓存的目的主要主要有两个：一是因为包是逐个发送的，需要发送完一个再发送下一个。二是因为我们需要根据帧的时间戳进行排序，排序完后再进行发送</p> <ul><li><p>准备发送</p> <ul><li><p>如果当前需要发送的帧是LFVideoFrame</p> <ul><li><p>视频帧发送前需要先发送sps和pps，如果未发送过，就要优先发送sendVideoHeader</p> <ul><li><p>然后发送视频帧sendVideo</p> <ul><li>通过PILI_RTMP_SendPacket函数发送出去</li></ul></li></ul></li></ul></li> <li><p>如果当前需要发送的帧是LFAudioFrame</p> <ul><li><p>音频帧发送前需要发送服务器将aac打包成flv所需要的头部信息(44100Hz为0x12、0x10)，即发送
body[0] = 0xAF;
body[1] = 0x01;</p> <ul><li><p>然后发送音频帧sendAudio</p> <ul><li>通过PILI_RTMP_SendPacket函数发送出去</li></ul></li></ul></li></ul></li></ul></li></ul></li></ul></li></ul></li></ul></li></ul></li></ul></li></ul></li></ul></li></ul></li></ul></li></ul></li></ul></li></ul></li></ul></li></ul></li></ul> <h2 id="ffmpeg可以推流"><a href="#ffmpeg可以推流" class="header-anchor">#</a> ffmpeg可以推流</h2> <p><em>XMind - Trial Version</em></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/iOS笔记/iOS性能优化.html" class="prev">
        iOS性能优化
      </a></span> <span class="next"><a href="/iOS笔记/Metal.html">
        Metal
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.9de76d75.js" defer></script><script src="/assets/js/2.98ea7a63.js" defer></script><script src="/assets/js/51.eaab3e31.js" defer></script>
  </body>
</html>
