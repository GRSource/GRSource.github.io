<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>RunLoop | 文档</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/assets/css/0.styles.e4d8b86b.css" as="style"><link rel="preload" href="/assets/js/app.9de76d75.js" as="script"><link rel="preload" href="/assets/js/2.98ea7a63.js" as="script"><link rel="preload" href="/assets/js/56.6f20785e.js" as="script"><link rel="prefetch" href="/assets/js/10.fa8eed47.js"><link rel="prefetch" href="/assets/js/11.f98f25e0.js"><link rel="prefetch" href="/assets/js/12.1ab9b5a3.js"><link rel="prefetch" href="/assets/js/13.75251b00.js"><link rel="prefetch" href="/assets/js/14.b5068189.js"><link rel="prefetch" href="/assets/js/15.33abd7e1.js"><link rel="prefetch" href="/assets/js/16.34ed8053.js"><link rel="prefetch" href="/assets/js/17.b3d52ea3.js"><link rel="prefetch" href="/assets/js/18.cbe71205.js"><link rel="prefetch" href="/assets/js/19.c632cb86.js"><link rel="prefetch" href="/assets/js/20.90d9a221.js"><link rel="prefetch" href="/assets/js/21.15cb7700.js"><link rel="prefetch" href="/assets/js/22.62ea968a.js"><link rel="prefetch" href="/assets/js/23.b743fdd5.js"><link rel="prefetch" href="/assets/js/24.5d157647.js"><link rel="prefetch" href="/assets/js/25.1935fba3.js"><link rel="prefetch" href="/assets/js/26.fd22f8ee.js"><link rel="prefetch" href="/assets/js/27.f47adfe7.js"><link rel="prefetch" href="/assets/js/28.d9f5719d.js"><link rel="prefetch" href="/assets/js/29.82cbf665.js"><link rel="prefetch" href="/assets/js/3.b96f613e.js"><link rel="prefetch" href="/assets/js/30.9f901f01.js"><link rel="prefetch" href="/assets/js/31.d9e2f61c.js"><link rel="prefetch" href="/assets/js/32.b14052e9.js"><link rel="prefetch" href="/assets/js/33.1b2e5efd.js"><link rel="prefetch" href="/assets/js/34.4bf7f44f.js"><link rel="prefetch" href="/assets/js/35.98d5fd2b.js"><link rel="prefetch" href="/assets/js/36.cdaf1c2f.js"><link rel="prefetch" href="/assets/js/37.a67bdb9a.js"><link rel="prefetch" href="/assets/js/38.5d856b83.js"><link rel="prefetch" href="/assets/js/39.27169c95.js"><link rel="prefetch" href="/assets/js/4.268c621c.js"><link rel="prefetch" href="/assets/js/40.8763c647.js"><link rel="prefetch" href="/assets/js/41.cd839f43.js"><link rel="prefetch" href="/assets/js/42.a97bf97a.js"><link rel="prefetch" href="/assets/js/43.fd126bb1.js"><link rel="prefetch" href="/assets/js/44.50e2b10d.js"><link rel="prefetch" href="/assets/js/45.0c29263b.js"><link rel="prefetch" href="/assets/js/46.fdee27aa.js"><link rel="prefetch" href="/assets/js/47.c7c7e966.js"><link rel="prefetch" href="/assets/js/48.80bc6f0a.js"><link rel="prefetch" href="/assets/js/49.d457b0ac.js"><link rel="prefetch" href="/assets/js/5.f577ebb9.js"><link rel="prefetch" href="/assets/js/50.cea3b0e6.js"><link rel="prefetch" href="/assets/js/51.eaab3e31.js"><link rel="prefetch" href="/assets/js/52.010a2dfb.js"><link rel="prefetch" href="/assets/js/53.3622f7b6.js"><link rel="prefetch" href="/assets/js/54.817aba2b.js"><link rel="prefetch" href="/assets/js/55.c3984ff9.js"><link rel="prefetch" href="/assets/js/57.07c7f6fc.js"><link rel="prefetch" href="/assets/js/58.4ec50d24.js"><link rel="prefetch" href="/assets/js/59.626b42b0.js"><link rel="prefetch" href="/assets/js/6.b9249342.js"><link rel="prefetch" href="/assets/js/60.ba2af5c7.js"><link rel="prefetch" href="/assets/js/61.6e22c298.js"><link rel="prefetch" href="/assets/js/62.df85ea27.js"><link rel="prefetch" href="/assets/js/63.cd3c1f6a.js"><link rel="prefetch" href="/assets/js/64.d0f75a86.js"><link rel="prefetch" href="/assets/js/65.12e0c392.js"><link rel="prefetch" href="/assets/js/66.aac422ac.js"><link rel="prefetch" href="/assets/js/67.3ff890c6.js"><link rel="prefetch" href="/assets/js/68.c6d12518.js"><link rel="prefetch" href="/assets/js/69.455e0c09.js"><link rel="prefetch" href="/assets/js/7.375eddd0.js"><link rel="prefetch" href="/assets/js/70.73d975e7.js"><link rel="prefetch" href="/assets/js/71.66528e07.js"><link rel="prefetch" href="/assets/js/72.a608a326.js"><link rel="prefetch" href="/assets/js/73.b8ed0811.js"><link rel="prefetch" href="/assets/js/74.68f4db5d.js"><link rel="prefetch" href="/assets/js/75.85059bdc.js"><link rel="prefetch" href="/assets/js/8.a04b9d9b.js"><link rel="prefetch" href="/assets/js/9.04a00c43.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e4d8b86b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">文档</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>iOS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>iOS笔记</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/iOS笔记/工具.html" class="sidebar-link">工具</a></li><li><a href="/iOS笔记/计算机网络.html" class="sidebar-link">计算机网络</a></li><li><a href="/iOS笔记/架构.html" class="sidebar-link">架构</a></li><li><a href="/iOS笔记/视频播放器设计（基于FFmpeg）.html" class="sidebar-link">视频播放器设计（基于FFmpeg）</a></li><li><a href="/iOS笔记/视频常识.html" class="sidebar-link">视频常识</a></li><li><a href="/iOS笔记/数据结构与算法分析.html" class="sidebar-link">数据结构与算法分析</a></li><li><a href="/iOS笔记/算法.html" class="sidebar-link">算法</a></li><li><a href="/iOS笔记/音频常识.html" class="sidebar-link">音频常识</a></li><li><a href="/iOS笔记/音视频开发.html" class="sidebar-link">音视频开发</a></li><li><a href="/iOS笔记/直播.html" class="sidebar-link">直播</a></li><li><a href="/iOS笔记/App启动优化.html" class="sidebar-link">App启动优化</a></li><li><a href="/iOS笔记/Audio.html" class="sidebar-link">Audio</a></li><li><a href="/iOS笔记/AudioToolbox.html" class="sidebar-link">AudioToolbox</a></li><li><a href="/iOS笔记/AVFoundation.html" class="sidebar-link">AVFoundation</a></li><li><a href="/iOS笔记/C.html#.html" class="sidebar-link">C</a></li><li><a href="/iOS笔记/C.html#.html" class="sidebar-link">C#</a></li><li><a href="/iOS笔记/C++.html" class="sidebar-link">C++</a></li><li><a href="/iOS笔记/CoreAudio.html" class="sidebar-link">CoreAudio</a></li><li><a href="/iOS笔记/CoreVideo.html" class="sidebar-link">CoreVideo</a></li><li><a href="/iOS笔记/FFmpeg.html" class="sidebar-link">FFmpeg</a></li><li><a href="/iOS笔记/Flutter.html" class="sidebar-link">Flutter</a></li><li><a href="/iOS笔记/GPUImage.html" class="sidebar-link">GPUImage</a></li><li><a href="/iOS笔记/ijkPlayer.html" class="sidebar-link">ijkPlayer</a></li><li><a href="/iOS笔记/iOS细节.html" class="sidebar-link">iOS细节</a></li><li><a href="/iOS笔记/iOS性能优化.html" class="sidebar-link">iOS性能优化</a></li><li><a href="/iOS笔记/LFLiveKit.html" class="sidebar-link">LFLiveKit</a></li><li><a href="/iOS笔记/Metal.html" class="sidebar-link">Metal</a></li><li><a href="/iOS笔记/Objective-C.html" class="sidebar-link">Objective-C</a></li><li><a href="/iOS笔记/OpenGL相关概念.html" class="sidebar-link">OpenGL相关概念</a></li><li><a href="/iOS笔记/pthread.html" class="sidebar-link">pthread</a></li><li><a href="/iOS笔记/ReactNative.html" class="sidebar-link">React Native</a></li><li><a href="/iOS笔记/RunLoop.html" class="active sidebar-link">RunLoop</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/iOS笔记/RunLoop.html#线程一一对应" class="sidebar-link">线程一一对应</a></li><li class="sidebar-sub-header"><a href="/iOS笔记/RunLoop.html#mode-item" class="sidebar-link">Mode Item</a></li><li class="sidebar-sub-header"><a href="/iOS笔记/RunLoop.html#系统架构" class="sidebar-link">系统架构</a></li><li class="sidebar-sub-header"><a href="/iOS笔记/RunLoop.html#用户态进入内核态" class="sidebar-link">用户态进入内核态</a></li><li class="sidebar-sub-header"><a href="/iOS笔记/RunLoop.html#核心" class="sidebar-link">核心</a></li><li class="sidebar-sub-header"><a href="/iOS笔记/RunLoop.html#mode" class="sidebar-link">Mode</a></li><li class="sidebar-sub-header"><a href="/iOS笔记/RunLoop.html#app启动-注册两个observer" class="sidebar-link">App启动，注册两个Observer</a></li><li class="sidebar-sub-header"><a href="/iOS笔记/RunLoop.html#系统" class="sidebar-link">系统</a></li><li class="sidebar-sub-header"><a href="/iOS笔记/RunLoop.html#runloop启动前必须至少有一个timer-observer-source" class="sidebar-link">runloop启动前必须至少有一个Timer/Observer/Source</a></li><li class="sidebar-sub-header"><a href="/iOS笔记/RunLoop.html#autoreleasepool" class="sidebar-link">AutoreleasePool</a></li></ul></li><li><a href="/iOS笔记/UI视图.html" class="sidebar-link">UI视图</a></li><li><a href="/iOS笔记/VideoToolbox.html" class="sidebar-link">VideoToolbox</a></li><li><a href="/iOS笔记/WebAssembly.html" class="sidebar-link">WebAssembly</a></li><li><a href="/iOS笔记/WebRTC.html" class="sidebar-link">WebRTC</a></li><li><a href="/iOS笔记/第三方.html" class="sidebar-link">第三方</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="runloop"><a href="#runloop" class="header-anchor">#</a> RunLoop</h1> <h2 id="线程一一对应"><a href="#线程一一对应" class="header-anchor">#</a> 线程一一对应</h2> <h2 id="mode-item"><a href="#mode-item" class="header-anchor">#</a> Mode Item</h2> <h3 id="主要使用的有三类"><a href="#主要使用的有三类" class="header-anchor">#</a> 主要使用的有三类</h3> <ul><li><p>Source</p> <ul><li><p>Source0</p> <p>不能主动触发</p> <ul><li><p>只包含回调的函数指针，需要手动触发</p> <ul><li><p>CFRunLoopSourceSignal(source)</p> <p>标记为待处理</p> <ul><li><p>CFRunLoopWakeUp(runloop)</p> <p>唤醒runloop，来处理事件</p></li></ul></li></ul></li></ul></li> <li><p>Source1</p> <p>可以主动触发(即主动唤醒runloop的线程)，用于内核和其他线程相互发送消息</p> <ul><li>包含mach_port</li> <li>包含回调指针</li></ul></li></ul></li> <li><p>Timer</p> <ul><li>包含时间长度</li> <li>包含回调指针</li></ul></li> <li><p>Observer</p> <ul><li><p>包含回调指针，观测点为：</p> <ul><li><p>entry</p> <p>即将进入loop</p></li> <li><p>beforeTimers</p> <p>即将处理Timer</p></li> <li><p>beforeSources</p> <p>即将处理Source</p></li> <li><p>beforeWaiting</p> <p>即将进入休眠</p></li> <li><p>AfterWaiting</p> <p>刚从休眠中唤醒</p></li> <li><p>Exit</p> <p>即将推出loop</p></li></ul></li></ul></li></ul> <h2 id="系统架构"><a href="#系统架构" class="header-anchor">#</a> 系统架构</h2> <h3 id="应用层"><a href="#应用层" class="header-anchor">#</a> 应用层</h3> <ul><li>用户解除到的图形应用</li></ul> <h3 id="应用框架层"><a href="#应用框架层" class="header-anchor">#</a> 应用框架层</h3> <ul><li>包含Cocoa等框架</li></ul> <h3 id="核心框架层"><a href="#核心框架层" class="header-anchor">#</a> 核心框架层</h3> <ul><li>包含核心框架、OpenGL等</li></ul> <h3 id="darwin"><a href="#darwin" class="header-anchor">#</a> Darwin</h3> <ul><li><p>包含系统内核、驱动、Shell等</p> <ul><li><p>XNU内核</p> <ul><li><p>IOKit</p></li> <li><p>BSD</p> <ul><li>提供了诸如进程管理、文件系统和网络等功能</li></ul></li> <li><p>Mach</p> <ul><li><p>提供了诸如处理器调度、iPC(进程间通信)等服务，通过消息传递的方式实现对象间通信。</p> <ul><li><p>Mach消息组成：</p> <ul><li><p>mach_msg_base_t</p> <ul><li><p>header</p> <ul><li>msgh_bits</li> <li>msgh_size</li> <li>msgh_remote_port</li> <li>msgh_local_port</li> <li>msgh_voucher_port</li> <li>msgh_id</li></ul></li> <li><p>body</p></li></ul></li></ul></li> <li><p>通过mach_msg来发送和接收消息</p> <ul><li>调用mach_msg_trap(系统调用)，进入内核态</li></ul></li></ul></li></ul></li></ul></li></ul></li></ul> <h2 id="用户态进入内核态"><a href="#用户态进入内核态" class="header-anchor">#</a> 用户态进入内核态</h2> <h3 id="程序异常"><a href="#程序异常" class="header-anchor">#</a> 程序异常</h3> <h3 id="发生系统调用"><a href="#发生系统调用" class="header-anchor">#</a> 发生系统调用</h3> <h3 id="外围设备的中断"><a href="#外围设备的中断" class="header-anchor">#</a> 外围设备的中断</h3> <h2 id="核心"><a href="#核心" class="header-anchor">#</a> 核心</h2> <h3 id="mach-msg"><a href="#mach-msg" class="header-anchor">#</a> mach_msg()</h3> <p>mach_msg()既可以用来接收消息，又可以用来发送消息</p> <ul><li><p>接收消息</p> <p>runloop通过这个函数去接收消息，如果没有别人发送port消息过来，内核就会将线程置于等待状态。例如你在模拟器里跑起一个 iOS 的 App，然后在 App 静止时点击暂停，你会看到主线程调用栈是停留在 mach_msg_trap() 这个地方。</p></li> <li><p>发送消息</p></li></ul> <h2 id="mode"><a href="#mode" class="header-anchor">#</a> Mode</h2> <h3 id="default"><a href="#default" class="header-anchor">#</a> default</h3> <h3 id="tracking"><a href="#tracking" class="header-anchor">#</a> tracking</h3> <h3 id="initialization"><a href="#initialization" class="header-anchor">#</a> initialization</h3> <p>启动时进入的第一个Mode，启动完成后不再使用</p> <h3 id="receive"><a href="#receive" class="header-anchor">#</a> receive</h3> <p>接收系统事件的内部Mode</p> <h3 id="commonmodes"><a href="#commonmodes" class="header-anchor">#</a> commonModes</h3> <h2 id="app启动-注册两个observer"><a href="#app启动-注册两个observer" class="header-anchor">#</a> App启动，注册两个Observer</h2> <p>主线程中，通常在事件回调、Timer回调会被AutoreleasePool环绕，所以不会出现内存泄漏</p> <h3 id="observer"><a href="#observer" class="header-anchor">#</a> Observer</h3> <p>优先级最高
回调函数_wrapRunLoopWithAutoreleasePoolHandler()</p> <ul><li>监听Entry事件，在回调内调用_objc_autoreleasePoolPush()创建自动释放池</li></ul> <h3 id="observer-2"><a href="#observer-2" class="header-anchor">#</a> Observer</h3> <p>回调函数_wrapRunLoopWithAutoreleasePoolHandler()</p> <ul><li>监听BeforeWaiting，在回调内调用pop()和push，释放旧的池并创建新池</li> <li>监听Exit，调用pop释放自动释放池</li></ul> <h2 id="系统"><a href="#系统" class="header-anchor">#</a> 系统</h2> <h3 id="苹果有注册一个source1用来接收系统事件-如触摸、锁屏、摇晃等-无回调指针"><a href="#苹果有注册一个source1用来接收系统事件-如触摸、锁屏、摇晃等-无回调指针" class="header-anchor">#</a> 苹果有注册一个Source1用来接收系统事件，如触摸、锁屏、摇晃等，无回调指针</h3> <p>我们知道，Source1主要是用来内核和线程间通信的，回调函数__IOHIDEventSystemClientQueueCallback()</p> <ul><li><p>触摸、锁屏、摇晃等</p> <ul><li><p>触发IOKit.framework</p> <ul><li><p>生成IOHIDEvent事件</p> <ul><li><p>SpringBoard接收</p> <ul><li><p>用mach port转发给需要的App进程</p> <ul><li><p>系统Source1的回调来触发_UIApplicationHandleEventQueue（）</p> <ul><li>_UIApplicationHandleEventQueue()将Event包装成UIEvent进行分发，随后系统将事件标记为待处理</li></ul></li></ul></li></ul></li></ul></li></ul></li></ul></li></ul> <h3 id="苹果启动时有注册一个observer"><a href="#苹果启动时有注册一个observer" class="header-anchor">#</a> 苹果启动时有注册一个Observer</h3> <ul><li>检测到BeforeWaiting时，触发回调函数来处理被标记为待处理的事件，例如手势事件、界面刷新等</li></ul> <h2 id="runloop启动前必须至少有一个timer-observer-source"><a href="#runloop启动前必须至少有一个timer-observer-source" class="header-anchor">#</a> runloop启动前必须至少有一个Timer/Observer/Source</h2> <h2 id="autoreleasepool"><a href="#autoreleasepool" class="header-anchor">#</a> AutoreleasePool</h2> <h3 id="主线程创建的对象-没有必要-显示-使用-autoreleasepool-因为应用在启动的时候系统已经为我们主动创建了"><a href="#主线程创建的对象-没有必要-显示-使用-autoreleasepool-因为应用在启动的时候系统已经为我们主动创建了" class="header-anchor">#</a> 主线程创建的对象，没有必要“显示”使用@autoreleasePool，因为应用在启动的时候系统已经为我们主动创建了</h3> <h3 id="子线程创建的对象-如果线程暂时不会退出-我们在创建对象的时候必须使用-autoreleasepool-以避免内存达到峰值-因为使用-autoreleasepool之后-对象会被打一个标记-在runloop进入休眠时-会释放-autoreleasepool中的对象-然后创建新池。如果线程执行完就退出-我们没有必要使用autoreleasepool-此时起不到任何作用-线程不会进入休眠-我们的对象会在线程结束时-全部释放掉。"><a href="#子线程创建的对象-如果线程暂时不会退出-我们在创建对象的时候必须使用-autoreleasepool-以避免内存达到峰值-因为使用-autoreleasepool之后-对象会被打一个标记-在runloop进入休眠时-会释放-autoreleasepool中的对象-然后创建新池。如果线程执行完就退出-我们没有必要使用autoreleasepool-此时起不到任何作用-线程不会进入休眠-我们的对象会在线程结束时-全部释放掉。" class="header-anchor">#</a> 子线程创建的对象，如果线程暂时不会退出，我们在创建对象的时候必须使用@autoreleasePool，以避免内存达到峰值，因为使用@autoreleasePool之后，对象会被打一个标记，在runloop进入休眠时，会释放@autoreleasePool中的对象，然后创建新池。如果线程执行完就退出，我们没有必要使用autoreleasePool，此时起不到任何作用，线程不会进入休眠，我们的对象会在线程结束时，全部释放掉。</h3> <p><em>XMind - Trial Version</em></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/iOS笔记/ReactNative.html" class="prev">
        React Native
      </a></span> <span class="next"><a href="/iOS笔记/UI视图.html">
        UI视图
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.9de76d75.js" defer></script><script src="/assets/js/2.98ea7a63.js" defer></script><script src="/assets/js/56.6f20785e.js" defer></script>
  </body>
</html>
