<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>AudioToolbox | 文档</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/assets/css/0.styles.e4d8b86b.css" as="style"><link rel="preload" href="/assets/js/app.9de76d75.js" as="script"><link rel="preload" href="/assets/js/2.98ea7a63.js" as="script"><link rel="preload" href="/assets/js/42.a97bf97a.js" as="script"><link rel="prefetch" href="/assets/js/10.fa8eed47.js"><link rel="prefetch" href="/assets/js/11.f98f25e0.js"><link rel="prefetch" href="/assets/js/12.1ab9b5a3.js"><link rel="prefetch" href="/assets/js/13.75251b00.js"><link rel="prefetch" href="/assets/js/14.b5068189.js"><link rel="prefetch" href="/assets/js/15.33abd7e1.js"><link rel="prefetch" href="/assets/js/16.34ed8053.js"><link rel="prefetch" href="/assets/js/17.b3d52ea3.js"><link rel="prefetch" href="/assets/js/18.cbe71205.js"><link rel="prefetch" href="/assets/js/19.c632cb86.js"><link rel="prefetch" href="/assets/js/20.90d9a221.js"><link rel="prefetch" href="/assets/js/21.15cb7700.js"><link rel="prefetch" href="/assets/js/22.62ea968a.js"><link rel="prefetch" href="/assets/js/23.b743fdd5.js"><link rel="prefetch" href="/assets/js/24.5d157647.js"><link rel="prefetch" href="/assets/js/25.1935fba3.js"><link rel="prefetch" href="/assets/js/26.fd22f8ee.js"><link rel="prefetch" href="/assets/js/27.f47adfe7.js"><link rel="prefetch" href="/assets/js/28.d9f5719d.js"><link rel="prefetch" href="/assets/js/29.82cbf665.js"><link rel="prefetch" href="/assets/js/3.b96f613e.js"><link rel="prefetch" href="/assets/js/30.9f901f01.js"><link rel="prefetch" href="/assets/js/31.d9e2f61c.js"><link rel="prefetch" href="/assets/js/32.b14052e9.js"><link rel="prefetch" href="/assets/js/33.1b2e5efd.js"><link rel="prefetch" href="/assets/js/34.4bf7f44f.js"><link rel="prefetch" href="/assets/js/35.98d5fd2b.js"><link rel="prefetch" href="/assets/js/36.cdaf1c2f.js"><link rel="prefetch" href="/assets/js/37.a67bdb9a.js"><link rel="prefetch" href="/assets/js/38.5d856b83.js"><link rel="prefetch" href="/assets/js/39.27169c95.js"><link rel="prefetch" href="/assets/js/4.268c621c.js"><link rel="prefetch" href="/assets/js/40.8763c647.js"><link rel="prefetch" href="/assets/js/41.cd839f43.js"><link rel="prefetch" href="/assets/js/43.fd126bb1.js"><link rel="prefetch" href="/assets/js/44.50e2b10d.js"><link rel="prefetch" href="/assets/js/45.0c29263b.js"><link rel="prefetch" href="/assets/js/46.fdee27aa.js"><link rel="prefetch" href="/assets/js/47.c7c7e966.js"><link rel="prefetch" href="/assets/js/48.80bc6f0a.js"><link rel="prefetch" href="/assets/js/49.d457b0ac.js"><link rel="prefetch" href="/assets/js/5.f577ebb9.js"><link rel="prefetch" href="/assets/js/50.cea3b0e6.js"><link rel="prefetch" href="/assets/js/51.eaab3e31.js"><link rel="prefetch" href="/assets/js/52.010a2dfb.js"><link rel="prefetch" href="/assets/js/53.3622f7b6.js"><link rel="prefetch" href="/assets/js/54.817aba2b.js"><link rel="prefetch" href="/assets/js/55.c3984ff9.js"><link rel="prefetch" href="/assets/js/56.6f20785e.js"><link rel="prefetch" href="/assets/js/57.07c7f6fc.js"><link rel="prefetch" href="/assets/js/58.4ec50d24.js"><link rel="prefetch" href="/assets/js/59.626b42b0.js"><link rel="prefetch" href="/assets/js/6.b9249342.js"><link rel="prefetch" href="/assets/js/60.ba2af5c7.js"><link rel="prefetch" href="/assets/js/61.6e22c298.js"><link rel="prefetch" href="/assets/js/62.df85ea27.js"><link rel="prefetch" href="/assets/js/63.cd3c1f6a.js"><link rel="prefetch" href="/assets/js/64.d0f75a86.js"><link rel="prefetch" href="/assets/js/65.12e0c392.js"><link rel="prefetch" href="/assets/js/66.aac422ac.js"><link rel="prefetch" href="/assets/js/67.3ff890c6.js"><link rel="prefetch" href="/assets/js/68.c6d12518.js"><link rel="prefetch" href="/assets/js/69.455e0c09.js"><link rel="prefetch" href="/assets/js/7.375eddd0.js"><link rel="prefetch" href="/assets/js/70.73d975e7.js"><link rel="prefetch" href="/assets/js/71.66528e07.js"><link rel="prefetch" href="/assets/js/72.a608a326.js"><link rel="prefetch" href="/assets/js/73.b8ed0811.js"><link rel="prefetch" href="/assets/js/74.68f4db5d.js"><link rel="prefetch" href="/assets/js/75.85059bdc.js"><link rel="prefetch" href="/assets/js/8.a04b9d9b.js"><link rel="prefetch" href="/assets/js/9.04a00c43.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e4d8b86b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">文档</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>iOS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>iOS笔记</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/iOS笔记/工具.html" class="sidebar-link">工具</a></li><li><a href="/iOS笔记/计算机网络.html" class="sidebar-link">计算机网络</a></li><li><a href="/iOS笔记/架构.html" class="sidebar-link">架构</a></li><li><a href="/iOS笔记/视频播放器设计（基于FFmpeg）.html" class="sidebar-link">视频播放器设计（基于FFmpeg）</a></li><li><a href="/iOS笔记/视频常识.html" class="sidebar-link">视频常识</a></li><li><a href="/iOS笔记/数据结构与算法分析.html" class="sidebar-link">数据结构与算法分析</a></li><li><a href="/iOS笔记/算法.html" class="sidebar-link">算法</a></li><li><a href="/iOS笔记/音频常识.html" class="sidebar-link">音频常识</a></li><li><a href="/iOS笔记/音视频开发.html" class="sidebar-link">音视频开发</a></li><li><a href="/iOS笔记/直播.html" class="sidebar-link">直播</a></li><li><a href="/iOS笔记/App启动优化.html" class="sidebar-link">App启动优化</a></li><li><a href="/iOS笔记/Audio.html" class="sidebar-link">Audio</a></li><li><a href="/iOS笔记/AudioToolbox.html" class="active sidebar-link">AudioToolbox</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/iOS笔记/AudioToolbox.html#采集设计到的类" class="sidebar-link">采集设计到的类</a></li><li class="sidebar-sub-header"><a href="/iOS笔记/AudioToolbox.html#audiocomponent" class="sidebar-link">AudioComponent</a></li><li class="sidebar-sub-header"><a href="/iOS笔记/AudioToolbox.html#audiounit" class="sidebar-link">AudioUnit</a></li><li class="sidebar-sub-header"><a href="/iOS笔记/AudioToolbox.html#audiounitproperties" class="sidebar-link">AudioUnitProperties</a></li><li class="sidebar-sub-header"><a href="/iOS笔记/AudioToolbox.html#aucomponent" class="sidebar-link">AUComponent</a></li><li class="sidebar-sub-header"><a href="/iOS笔记/AudioToolbox.html#audiooutputunit" class="sidebar-link">AudioOutputUnit</a></li><li class="sidebar-sub-header"><a href="/iOS笔记/AudioToolbox.html#componenttype和componentsubtype根据不同的音频单元功能来设置" class="sidebar-link">componentType和componentSubType根据不同的音频单元功能来设置</a></li><li class="sidebar-sub-header"><a href="/iOS笔记/AudioToolbox.html#audiostreambasicdescription-inputformat-0" class="sidebar-link">AudioStreamBasicDescription inputFormat = {0};</a></li><li class="sidebar-sub-header"><a href="/iOS笔记/AudioToolbox.html#audiostreambasicdescription-outputformat-这里开始是输出音频格式" class="sidebar-link">AudioStreamBasicDescription outputFormat; // 这里开始是输出音频格式</a></li><li class="sidebar-sub-header"><a href="/iOS笔记/AudioToolbox.html#audioclassdescription-requestedcodecs-2" class="sidebar-link">AudioClassDescription requestedCodecs[2] = {</a></li><li class="sidebar-sub-header"><a href="/iOS笔记/AudioToolbox.html#audioconverter" class="sidebar-link">AudioConverter</a></li><li class="sidebar-sub-header"><a href="/iOS笔记/AudioToolbox.html#编码相关" class="sidebar-link">编码相关</a></li><li class="sidebar-sub-header"><a href="/iOS笔记/AudioToolbox.html#构建音频单元流程-解码播放" class="sidebar-link">构建音频单元流程（解码播放）</a></li><li class="sidebar-sub-header"><a href="/iOS笔记/AudioToolbox.html#构建音频流描述符audiostreambasicdescription" class="sidebar-link">构建音频流描述符AudioStreamBasicDescription</a></li><li class="sidebar-sub-header"><a href="/iOS笔记/AudioToolbox.html#audiounitscope和audiounitelement介绍" class="sidebar-link">AudioUnitScope和AudioUnitElement介绍</a></li><li class="sidebar-sub-header"><a href="/iOS笔记/AudioToolbox.html#adts头" class="sidebar-link">ADTS头</a></li><li class="sidebar-sub-header"><a href="/iOS笔记/AudioToolbox.html#编码" class="sidebar-link">编码</a></li><li class="sidebar-sub-header"><a href="/iOS笔记/AudioToolbox.html#编码器描述符" class="sidebar-link">编码器描述符</a></li></ul></li><li><a href="/iOS笔记/AVFoundation.html" class="sidebar-link">AVFoundation</a></li><li><a href="/iOS笔记/C.html#.html" class="sidebar-link">C</a></li><li><a href="/iOS笔记/C.html#.html" class="sidebar-link">C#</a></li><li><a href="/iOS笔记/C++.html" class="sidebar-link">C++</a></li><li><a href="/iOS笔记/CoreAudio.html" class="sidebar-link">CoreAudio</a></li><li><a href="/iOS笔记/CoreVideo.html" class="sidebar-link">CoreVideo</a></li><li><a href="/iOS笔记/FFmpeg.html" class="sidebar-link">FFmpeg</a></li><li><a href="/iOS笔记/Flutter.html" class="sidebar-link">Flutter</a></li><li><a href="/iOS笔记/GPUImage.html" class="sidebar-link">GPUImage</a></li><li><a href="/iOS笔记/ijkPlayer.html" class="sidebar-link">ijkPlayer</a></li><li><a href="/iOS笔记/iOS细节.html" class="sidebar-link">iOS细节</a></li><li><a href="/iOS笔记/iOS性能优化.html" class="sidebar-link">iOS性能优化</a></li><li><a href="/iOS笔记/LFLiveKit.html" class="sidebar-link">LFLiveKit</a></li><li><a href="/iOS笔记/Metal.html" class="sidebar-link">Metal</a></li><li><a href="/iOS笔记/Objective-C.html" class="sidebar-link">Objective-C</a></li><li><a href="/iOS笔记/OpenGL相关概念.html" class="sidebar-link">OpenGL相关概念</a></li><li><a href="/iOS笔记/pthread.html" class="sidebar-link">pthread</a></li><li><a href="/iOS笔记/ReactNative.html" class="sidebar-link">React Native</a></li><li><a href="/iOS笔记/RunLoop.html" class="sidebar-link">RunLoop</a></li><li><a href="/iOS笔记/UI视图.html" class="sidebar-link">UI视图</a></li><li><a href="/iOS笔记/VideoToolbox.html" class="sidebar-link">VideoToolbox</a></li><li><a href="/iOS笔记/WebAssembly.html" class="sidebar-link">WebAssembly</a></li><li><a href="/iOS笔记/WebRTC.html" class="sidebar-link">WebRTC</a></li><li><a href="/iOS笔记/第三方.html" class="sidebar-link">第三方</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="audiotoolbox"><a href="#audiotoolbox" class="header-anchor">#</a> AudioToolbox</h1> <h2 id="采集设计到的类"><a href="#采集设计到的类" class="header-anchor">#</a> 采集设计到的类</h2> <h2 id="audiocomponent"><a href="#audiocomponent" class="header-anchor">#</a> AudioComponent</h2> <h3 id="_1-audiocomponentdescription"><a href="#_1-audiocomponentdescription" class="header-anchor">#</a> 1.AudioComponentDescription</h3> <ul><li><p>componentType</p> <p>一个音频组件的通用的独特的四字节码标识</p></li> <li><p>componentSubType</p> <p>根据componentType设置相应的类型</p></li> <li><p>componentManufacturer</p> <p>厂商的身份验证</p></li> <li><p>componentFlags</p> <p>如果没有一个明确指定的值，那么他必须被设置为0</p> <ul><li>0</li></ul></li> <li><p>componentFlagsMask</p> <p>如果没有一个明确指定的值，那么他必须被设置为0</p> <ul><li>0</li></ul></li> <li><p>例子</p> <ul><li>AudioComponentDescription ioUnitDescription;
ioUnitDescription.componentType = kAudioUnitType_Output;
ioUnitDescription.componentSubType = kAudioUnitSubType_RemoteIO;
ioUnitDescription.componentManufacturer = kAudioUnitManufacturer_Apple;
ioUnitDescription.componentFlags = 0;
ioUnitDescription.componentFlagsMask = 0;</li></ul></li></ul> <h3 id="_2-audiocomponent-foundiounitreference-audiocomponentfindnext-null-iounitdescription"><a href="#_2-audiocomponent-foundiounitreference-audiocomponentfindnext-null-iounitdescription" class="header-anchor">#</a> 2.AudioComponent foundIoUnitReference = AudioComponentFindNext(NULL, &amp;ioUnitDescription);</h3> <p>如果第一个参数传空，按照系统定义的排序，找到第一个符合的 audio unit ，如果该参数为先前找到的音频单元，则该功能找到与描述匹配的下一个 audio unit，例如此用法可以通过重复调用 AudioComponentFindNext 来获取所有 I/O 单元的引用。</p> <h2 id="audiounit"><a href="#audiounit" class="header-anchor">#</a> AudioUnit</h2> <p>即AudioComponentInstance</p> <h3 id="_3-audiounit-iounitinstance"><a href="#_3-audiounit-iounitinstance" class="header-anchor">#</a> 3.AudioUnit ioUnitInstance;</h3> <div class="language- extra-class"><pre><code>AudioComponentInstanceNew(foundIoUnitReference, &amp;ioUnitInstance);
</code></pre></div><p>初始化componentInstance</p> <h3 id="_4-设置属性-可以使用函数-audiounitsetproperty"><a href="#_4-设置属性-可以使用函数-audiounitsetproperty" class="header-anchor">#</a> 4.设置属性，可以使用函数 AudioUnitSetProperty</h3> <p>第二个 参数AudioUnitPropertyID表示key，就是说你要设置什么类型的属性，比如EnableIO开启输入输出、streamFormat音频流格式等等。</p> <ul><li><p>UInt32 flagOne = 1;
AudioUnitSetProperty(ioUnitInstance, kAudioOutputUnitProperty_EnableIO, kAudioUnitScope_Input, 1, &amp;flagOne, sizeof(flagOne));</p> <p>AudioUnitSetProperty(_ioUnit,kAudioOutputUnitProperty_EnableIO , kAudioUnitScope_Output,0, &amp;flag, sizeof(flag));</p> <p>上面的1表示Element1为和录音的麦克风相连，0表示Element0和输出硬件相连。，flagOne不知道啥意思，是成功与否的标致吗？</p></li></ul> <h3 id="常见的属性"><a href="#常见的属性" class="header-anchor">#</a> 常见的属性</h3> <p>大部分属性可以在 audio unit 未初始化的时候设置，因为这些属性一般不会发生改变，有些属性像 iPod EQ unit 中的 kAudioUnitProperty_PresentPreset和 Voice-Processing I/O unit 中的 kAUVoiceIOProperty_MuteOutput 这些属性会在播放音频的时候也会发生改变</p> <ul><li><p>kAudioOutputUnitProperty_EnableIO</p> <p>启用或禁止 I/O，默认输出开启，输入禁止。</p></li> <li><p>kAudioUnitProperty_ElementCount</p> <p>配置元素个数</p></li> <li><p>kAudioUnitProperty_MaximumFramesPerSlice</p> <p>设置 audio unit 的最大帧数</p></li> <li><p>kAudioUnitProperty_StreamFormat</p> <p>指定输入 audio unit 输入输出元素的数据格式</p></li></ul> <h2 id="audiounitproperties"><a href="#audiounitproperties" class="header-anchor">#</a> AudioUnitProperties</h2> <h3 id="aurendercallbackstruct"><a href="#aurendercallbackstruct" class="header-anchor">#</a> AURenderCallbackStruct</h3> <p>用于给audio unit的输入总线提供数据，
AURenderCallbackStruct cb;</p> <ul><li><p>inputProcRefCon</p> <ul><li>(__bridge void *)(self);</li></ul></li> <li><p>inputProc设置回调函数</p> <p>回调函数，从回调函数得到音频数据，可能线程不安全，也可通过AUGraph来设置回调函数，线程安全</p> <ul><li><p>static OSStatus handleInputBuffer(void *inRefCon,
AudioUnitRenderActionFlags *ioActionFlags,
const AudioTimeStamp *inTimeStamp,
UInt32 inBusNumber,
UInt32 inNumberFrames,
AudioBufferList *ioData)</p> <ul><li>回调中调用AudioUnitRender，似乎是取数据用的？</li></ul></li></ul></li></ul> <h2 id="aucomponent"><a href="#aucomponent" class="header-anchor">#</a> AUComponent</h2> <h3 id="audiounitinitialize"><a href="#audiounitinitialize" class="header-anchor">#</a> AudioUnitInitialize</h3> <h2 id="audiooutputunit"><a href="#audiooutputunit" class="header-anchor">#</a> AudioOutputUnit</h2> <h3 id="audiooutputunitstart"><a href="#audiooutputunitstart" class="header-anchor">#</a> AudioOutputUnitStart</h3> <h3 id="audiooutputunitstop"><a href="#audiooutputunitstop" class="header-anchor">#</a> AudioOutputUnitStop</h3> <h2 id="componenttype和componentsubtype根据不同的音频单元功能来设置"><a href="#componenttype和componentsubtype根据不同的音频单元功能来设置" class="header-anchor">#</a> componentType和componentSubType根据不同的音频单元功能来设置</h2> <h3 id="按使用场景分类"><a href="#按使用场景分类" class="header-anchor">#</a> 按使用场景分类</h3> <ul><li><p>Converter unit</p> <p>转换器单元，支持线性PCM的音频格式转换。</p> <ul><li><p>componentType</p> <ul><li>kAudioUnitType_FormatConverter</li></ul></li> <li><p>componentSubType</p> <ul><li>kAudioUnitSubType_AUConverter</li></ul></li></ul></li> <li><p>iPod Equalizer unit</p> <p>iOS 4 提供了一个效果单元，iPod Equalizer，与 iPod 内置应用使用相同的均衡器。查看这个 audio unit 的 iPod 应用用户界面，进入设置 -&gt; iPod -&gt; EQ。当使用此 audio unit，必须提供自己的用户界面。此 audio unit 提供了一组预设的均衡曲线，例如低音增强，Pop 和 Spoken Word。iPod均衡器，提供iPod均衡器的功能。</p> <ul><li><p>componentType</p> <ul><li>kAudioUnitType_Effect</li></ul></li> <li><p>componentSubType</p> <ul><li>kAudioUnitSubType_AUiPodEQ</li></ul></li></ul></li> <li><p>3D Mixer unit</p> <p>iOS 提供两个 mixer units。3D Mixer unit 是 OpenAL 的基础，如果需要实现 3D Mixer unit 的特征，可以优先使用 OpenAL，它提供了高级 API，并且非常适合游戏应用程序。3D混音器单元，支持混合多个音频流，输出平移，采样率转换等。</p> <ul><li><p>componentType</p> <ul><li>kAudioUnitType_Mixer</li></ul></li> <li><p>componentSubType</p> <ul><li>kAudioUnitSubType_SpatialMixer</li></ul></li></ul></li> <li><p>Multichannel Mixer unit</p> <p>Multichannel Mixer unit 为任意数量的单声道或立体声提供混音，立体声输出。可以打开和关闭每一个输入，设置输入增益，并设置立体声平移位置。多通道混合器单元，支持将多个音频流混合到一个流中。</p> <ul><li><p>componentType</p> <ul><li>kAudioUnitType_Mixer</li></ul></li> <li><p>componentSubType</p> <ul><li>kAudioUnitSubType_MultiChannelMixer</li></ul></li></ul></li> <li><p>Generic Output unit</p> <p>Generic Output unit 不连接音频硬件，而是提供了一种将处理链的输出发送到应用程序的机制。通常会使用做离线音频处理。通用输出单元，支持向和从线性PCM格式转换；可以用来启动和停止图形。</p> <ul><li><p>componentType</p> <ul><li><p>kAudioUnitType_Output</p> <p>提供的就是I/O的功能</p></li></ul></li> <li><p>componentSubType</p> <ul><li><p>kAudioUnitSubType_GenericOutput</p> <p>当 开发者需要进行离线处理，或者说在AUGraph中不使用Speaker(扬声 器)来驱动整个数据流（通常都是Speaker向前一级AUNode要数据），而是希望使用一个输出(可以放入内存队列或 者进行磁盘I/O操作)来驱动数据流时，就使用该子类型。</p></li></ul></li></ul></li> <li><p>Remote I/O unit，音频输出就是用它了</p> <p>iOS 提供了三个 I/O units，其中 Remote I/O unit 是最常用的。连接输入输出音频硬件，对传入和传出的样本值低延迟访问，提供硬件音频格式和应用音频格式之间的格式转化。远程I/O单元，连接到硬件设备，用于输入、输出或同时输入和输出。</p> <ul><li><p>componentType</p> <ul><li>kAudioUnitType_Output</li></ul></li> <li><p>componentSubType</p> <ul><li><p>kAudioUnitSubType_RemoteIO</p> <p>用来采集音频与播放音频的</p></li></ul></li></ul></li> <li><p>Voice Processing I/O unit</p> <p>Voice-Processing I/O unit 是对 Remote I/O unit 的拓展，添加了语音聊天中的回声消除，还提供了自动增益矫正，语音质量调整，静音等特性。语音处理I/O单元，具有I/O单元的特性并为双向通信添加回声抑制。</p> <ul><li><p>componentType</p> <ul><li>kAudioUnitType_Output</li></ul></li> <li><p>componentSubType</p> <ul><li>kAudioUnitSubType_VoiceProcessingIO</li></ul></li></ul></li></ul> <h3 id="按类型和子类型分类"><a href="#按类型和子类型分类" class="header-anchor">#</a> 按类型和子类型分类</h3> <ul><li><p>kAudioUnitType_Effect</p> <p>提供声音特效处理</p> <ul><li><p>kAudioUnitSubType_NBandEQ</p> <p>均衡效果器，主要作用 是为声音的某些频带增强或者减弱能量，该效果器需要指定多个频带， 然后为各个频带设置宽度以及增益，最终将改变声音在频域上的能量分 布。个人理解似乎是降噪关键</p></li> <li><p>kAudioUnitSubType_DynamicsProcessor</p> <p>压缩效果器，主 要作用是当声音较小的时候可以提高声音的能量，当声音的能量超过了 设置的阈值时，可以降低声音的能量，当然应合理地设置作用时间、释 放时间以及触发值，使得最终可以将声音在时域上的能量压缩到一定范 围之内。</p></li> <li><p>kAudioUnitSubType_Reverb2</p> <p>混响效果器，对于人声处 理来讲这是非常重要的效果器，可以想象自己身处在一个空房子中，如 果有非常多的反射声和原始声音叠加在一起，那么从听感上可能会更有 震撼力，但是同时原始声音也会变得更加模糊，原始声音的一些细节会 被遮盖掉，所以混响设置的大或者小对于不同的人来讲会很不一致，可 以根据自己的喜好来进行设置。</p></li></ul></li> <li><p>kAudioUnitType_Mixer</p> <p>提供Mix多路声音的功能</p> <ul><li><p>3D Mixer</p> <p>该效果器在移动设备上是无法使用。</p></li> <li><p>kAudioUnitSubType_MultiChannelMixer</p> <p>该效果器将是本书重点介绍的 对象，它是多路声音混音的效果器，可以接收多路音频的输入，还可以 分别调整每一路音频的增益与开关，并将多路音频合并成一路，该效果 器在处理音频的图状结构中非常有用。</p></li></ul></li> <li><p>kAudioUnitType_Output</p> <p>提供的就是I/O的功能</p> <ul><li><p>kAudioUnitSubType_RemoteIO</p> <p>用来采集音频与播放音频的</p></li> <li><p>kAudioUnitSubType_GenericOutput</p> <p>当 开发者需要进行离线处理，或者说在AUGraph中不使用Speaker(扬声 器)来驱动整个数据流（通常都是Speaker向前一级AUNode要数据），而是希望使用一个输出(可以放入内存队列或 者进行磁盘I/O操作)来驱动数据流时，就使用该子类型。</p></li></ul></li> <li><p>kAudioUnitType_FormatConverter</p> <p>主要用于提供格式转换 的功能，比如:采样格式由Float到SInt16的转换、交错和平铺的格式转 换、单双声道的转换等，</p> <ul><li><p>kAudioUnitSubType_AUConverter</p> <p>当某些效果器对输入的音频格式有 明确的要求时(比如3D Mixer Unit就必须使用UInt16格式的sample)， 或者开发者将音频数据输入给一些其他的编码器进行编码，又或者开发
     者想使用SInt16格式的PCM裸数据在其他CPU上进行音频算法计算等的 场景下，就需要使用到这个ConverterNode了。下面来看一个比较典型的 场景，我们自定义一个音频播放器(代码仓库中的AudioPlayer项目)， 由FFmpeg解码出来的PCM数据是SInt16格式的，因此不能直接输送给 RemoteIO Unit进行播放，所以需要构建一个ConvertNode将SInt16格式 表示的数据转换为Float32格式表示的数据，然后再输送给RemoteIO Unit，最终才能正常播放出来。</p></li> <li><p>kAudioUnitSubType_NewTimePitch</p> <p>变速 变调效果器，这是一个很有意思的效果器，可以对声音的音高、速度进 行调整，像“会说话的Tom猫”类似的应用场景就可以使用这个效果器来 实现。</p></li></ul></li> <li><p>kAudioUnitType_Generator</p> <p>使用它来提供播放器的功能</p> <ul><li><p>kAudioUnitSubType_AudioFilePlayer</p> <p>在AudioUnit里面，如果我们的输入不是麦克风，而希望其是一个媒体 文件，当然，也可以类似于代码仓库中的AudioPlayer项目自行解码，转 换之后将数据输送给RemoteIO Unit播放出来</p></li></ul></li></ul> <h2 id="audiostreambasicdescription-inputformat-0"><a href="#audiostreambasicdescription-inputformat-0" class="header-anchor">#</a> AudioStreamBasicDescription inputFormat = {0};</h2> <h2 id="audiostreambasicdescription-outputformat-这里开始是输出音频格式"><a href="#audiostreambasicdescription-outputformat-这里开始是输出音频格式" class="header-anchor">#</a> AudioStreamBasicDescription outputFormat; // 这里开始是输出音频格式</h2> <h2 id="audioclassdescription-requestedcodecs-2"><a href="#audioclassdescription-requestedcodecs-2" class="header-anchor">#</a> AudioClassDescription requestedCodecs[2] = {</h2> <h2 id="audioconverter"><a href="#audioconverter" class="header-anchor">#</a> AudioConverter</h2> <h3 id="audioconverternewspecific-inputformat-outputformat-2-requestedcodecs-m-converter"><a href="#audioconverternewspecific-inputformat-outputformat-2-requestedcodecs-m-converter" class="header-anchor">#</a> AudioConverterNewSpecific(&amp;inputFormat, &amp;outputFormat, 2, requestedCodecs, &amp;m_converter);;</h3> <p>创建编码器</p> <ul><li>AudioConverterFillComplexBuffer编码函数</li></ul> <h3 id="设置属性audioconvertersetproperty-m-converter-kaudioconverterencodebitrate-propsize-outputbitrate"><a href="#设置属性audioconvertersetproperty-m-converter-kaudioconverterencodebitrate-propsize-outputbitrate" class="header-anchor">#</a> 设置属性AudioConverterSetProperty(m_converter, kAudioConverterEncodeBitRate, propSize, &amp;outputBitrate);</h3> <h2 id="编码相关"><a href="#编码相关" class="header-anchor">#</a> 编码相关</h2> <h2 id="构建音频单元流程-解码播放"><a href="#构建音频单元流程-解码播放" class="header-anchor">#</a> 构建音频单元流程（解码播放）</h2> <h3 id="_1-创建augraph-相当于上下文"><a href="#_1-创建augraph-相当于上下文" class="header-anchor">#</a> 1.创建AUGraph(相当于上下文)</h3> <ul><li><p>2.添加各种node</p> <ul><li><p>3.打开AUGraph</p> <ul><li><p>4.通过nodeid获取AudioUnit</p> <ul><li><p>5.创建音频流描述符</p> <ul><li><p>6.为AudioUnit添加属性（比如添加第5步音频流属性）</p> <p>AudioStreamBasicDescription streamFormat = [self nonInterleavedPCMFormatWithChannels:2];
  status = AudioUnitSetProperty(_ioUnit, kAudioUnitProperty_StreamFormat, kAudioUnitScope_Output, 1,
                 &amp;streamFormat, sizeof(streamFormat));
ioUnit表示为哪个AudioUnit设置属性。
kAudioUnitProperty_StreamFormat表示设置的是流格式信息。
kAudioUnitScope_Output表示的是属性添加到AudioUnit的输出范围。我们知道，麦克风的输入和扬声器的输出是由系统控制的，我们没办法接管，我们只能接管麦克风的输出和扬声器的输入，那么谁的输出能被app控制呢？没错，就是麦克风输出的音频流能被app控制。
AudioUnitElement表示系统的Element，其中Element1表示麦克风和app的通道，Element0表示app和扬声器的通道。
所以上面代码的意思就是将流格式运用于麦克风的输出上面，那么我们app拿到的原始音频流就是streamFormat类型。</p> <ul><li><p>7.连接node，并设置回调</p> <ul><li><p>8.AUGraphInitialize</p> <ul><li>9.AUGraphStart开始</li> <li>10.AUGraphStop停止</li></ul></li></ul></li></ul></li></ul></li></ul></li></ul></li></ul></li></ul> <h2 id="构建音频流描述符audiostreambasicdescription"><a href="#构建音频流描述符audiostreambasicdescription" class="header-anchor">#</a> 构建音频流描述符AudioStreamBasicDescription</h2> <h3 id="msamplerate"><a href="#msamplerate" class="header-anchor">#</a> mSampleRate</h3> <p>采样率</p> <h3 id="mformatid"><a href="#mformatid" class="header-anchor">#</a> mFormatID</h3> <p>格式</p> <ul><li>kAudioFormatLinearPCM</li></ul> <h3 id="mformatflags"><a href="#mformatflags" class="header-anchor">#</a> mFormatFlags</h3> <p>float类型的packet，且是非交错类型</p> <ul><li>kAudioFormatFlagsNativeFloatPacked | kAudioFormatFlagIsNonInterleaved</li></ul> <h3 id="mbitsperchannel"><a href="#mbitsperchannel" class="header-anchor">#</a> mBitsPerChannel</h3> <p>每帧的比特率，即位深，根据每个样品的字节数x8。
UInt32 bytesPerSample = sizeof(Float32);</p> <ul><li>8 * bytesPerSample</li></ul> <h3 id="mbytesperframe"><a href="#mbytesperframe" class="header-anchor">#</a> mBytesPerFrame</h3> <p>每帧的字节数</p> <ul><li>bytesPerSample</li></ul> <h3 id="mbytesperpacket"><a href="#mbytesperpacket" class="header-anchor">#</a> mBytesPerPacket</h3> <p>每个packet的字节数，可能和frame的字节数不一样，因为一个packet可能包含多个frame</p> <ul><li>bytesPerSample</li></ul> <h3 id="mframesperpacket"><a href="#mframesperpacket" class="header-anchor">#</a> mFramesPerPacket</h3> <p>每个packet对应的帧数，一般每个packet可以有1帧音频及以上</p> <ul><li>1</li></ul> <h3 id="mchannelsperframe"><a href="#mchannelsperframe" class="header-anchor">#</a> mChannelsPerFrame</h3> <p>通道数</p> <h2 id="audiounitscope和audiounitelement介绍"><a href="#audiounitscope和audiounitelement介绍" class="header-anchor">#</a> AudioUnitScope和AudioUnitElement介绍</h2> <h3 id="audiounitelement代表的是通道-一般有两条通道-0表示输出通道-1表示输入通道-而输入通道和输出通道又有通道头和通道尾-如果audiounit类型是remoteio-那么输入通道的scopeinput连接麦克风-我们无法控制input流格式-输出通道的scopeoutput连接扬声器-我们也无法控制ouput的流格式-此时我们只能控制输入通道的通道尾-scopeoutput-和输出通道的通道头-scopeinput-输入通道的数据交给app-输出通道同app拿数据-如果不是remoteio类型-那我们就可以随意控制流格式信息了。这就是element和scope的关系"><a href="#audiounitelement代表的是通道-一般有两条通道-0表示输出通道-1表示输入通道-而输入通道和输出通道又有通道头和通道尾-如果audiounit类型是remoteio-那么输入通道的scopeinput连接麦克风-我们无法控制input流格式-输出通道的scopeoutput连接扬声器-我们也无法控制ouput的流格式-此时我们只能控制输入通道的通道尾-scopeoutput-和输出通道的通道头-scopeinput-输入通道的数据交给app-输出通道同app拿数据-如果不是remoteio类型-那我们就可以随意控制流格式信息了。这就是element和scope的关系" class="header-anchor">#</a> AudioUnitElement代表的是通道，一般有两条通道，0表示输出通道，1表示输入通道，而输入通道和输出通道又有通道头和通道尾，如果AudioUnit类型是RemoteIO，那么输入通道的scopeinput连接麦克风，我们无法控制input流格式，输出通道的scopeoutput连接扬声器，我们也无法控制ouput的流格式，此时我们只能控制输入通道的通道尾(scopeoutput)和输出通道的通道头(scopeinput)，输入通道的数据交给app，输出通道同app拿数据，如果不是remoteIO类型，那我们就可以随意控制流格式信息了。这就是element和scope的关系</h3> <h3 id="输入输出通道数可以不对称-即可以没有输入通道-因为我们可以直接从app参数输入-然后传入输出通道。"><a href="#输入输出通道数可以不对称-即可以没有输入通道-因为我们可以直接从app参数输入-然后传入输出通道。" class="header-anchor">#</a> 输入输出通道数可以不对称，即可以没有输入通道，因为我们可以直接从app参数输入，然后传入输出通道。</h3> <h2 id="adts头"><a href="#adts头" class="header-anchor">#</a> ADTS头</h2> <p>总共7个字节</p> <h3 id="adts-fixed-header"><a href="#adts-fixed-header" class="header-anchor">#</a> adts_fixed_header</h3> <p>占用28个bit位</p> <ul><li><p>packet[0]</p> <ul><li><p>syncword ：同步头 总是0xFFF, all bits must be 1，代表着一个ADTS帧的开始，占用12个比特位，所以packet[1]中前4位也是1，是属于syncword的标识</p> <ul><li>11111111</li></ul></li></ul></li> <li><p>packet[1]</p> <ul><li><p>ID：MPEG Version: 0 for MPEG-4, 1 for MPEG-2，占用1个比特位，即packet[1]中的高位第5位</p> <ul><li>1111   1</li></ul></li> <li><p>Layer：always: '00'，占用两个比特位，即packet[1]中的第6和第7位</p> <ul><li>00</li></ul></li> <li><p>protection_absent：第8位，总是为1</p> <ul><li>1</li></ul></li></ul></li> <li><p>packet[2]</p> <ul><li><p>高位2个bit表示：profile：表示使用哪个级别的AAC，有些芯片只支持AAC LC 。在MPEG-2 AAC中定义了3种：</p> <ul><li>0代表main profile</li> <li>1.代表LC</li> <li>2.SSR</li> <li>3.reserved</li></ul></li> <li><p>sampling_frequency_index：表示使用的采样率下标，通过这个下标在 Sampling Frequencies[ ]数组中查找得知采样率的值。占4个比特位</p> <ul><li>0: 96000 Hz</li> <li>1: 88200 Hz</li> <li>2: 64000 Hz</li> <li>3: 48000 Hz</li> <li>4: 44100 Hz</li> <li>5: 32000 Hz</li> <li>6: 24000 Hz</li> <li>7: 22050 Hz</li> <li>8: 16000 Hz</li> <li>9: 12000 Hz</li> <li>10: 11025 Hz</li> <li>11: 8000 Hz</li> <li>12: 7350 Hz</li> <li>13: Reserved</li> <li>14: Reserved</li> <li>15: frequency is written explictly</li></ul></li> <li><p>private_bit:第7位，总是为0</p></li> <li><p>channel_configuration：声道数，占三个bit，所以packet[3]中的前2个bit也是这个属性的标识</p> <ul><li>0: Defined in AOT Specifc Config</li> <li>1: 1 channel: front-center</li> <li>2: 2 channels: front-left, front-right</li> <li>3: 3 channels: front-center, front-left, front-right</li> <li>4: 4 channels: front-center, front-left, front-right, back-center</li> <li>5: 5 channels: front-center, front-left, front-right, back-left, back-right</li> <li>6: 6 channels: front-center, front-left, front-right, back-left, back-right, LFE-channel</li> <li>7: 8 channels: front-center, front-left, front-right, side-left, side-right, back-left, back-right, LFE-channel</li> <li>8-15: Reserved</li></ul></li></ul></li> <li><p>packet[3]</p> <ul><li>original_copy：占用1个bit位，从高位算起第3位，通常为0</li> <li>home：占用1个bit位，第4位，通常为0</li></ul></li></ul> <h3 id="adts-variable-header"><a href="#adts-variable-header" class="header-anchor">#</a> adts_variable_header</h3> <p>占用28个bit位</p> <ul><li><p>packet[3]</p> <ul><li>copyright_identification_bit：占用1个比特位，第5位，通常为0</li> <li>copyright_identification_start：占用1个比特位，第6位，通常为0</li></ul></li> <li><p>packet[4]</p> <ul><li>aac_frame_length：帧的长度（包含了ADTS头(7字节)和AAC原始流），占用13个比特位，所以packet[3]的后2位、packet[4]的8位、packet[5]的前3位都该属性的标识</li></ul></li> <li><p>packet[5]</p> <ul><li>adts_buffer_fullness：0x7FF 说明是码率可变的码流，占用11个bit位，所以packet[5]的后5位和packet[6]的前6位都是该属性的标识</li></ul></li> <li><p>packet[6]</p> <ul><li>number_of_raw_data_blocks_in_frame：占用2个bit位，packet[6]的后2位是该属性的标识</li></ul></li></ul> <h2 id="编码"><a href="#编码" class="header-anchor">#</a> 编码</h2> <h3 id="_1-构建音频描述符audiostreambasicdescription"><a href="#_1-构建音频描述符audiostreambasicdescription" class="header-anchor">#</a> 1.构建音频描述符AudioStreamBasicDescription</h3> <ul><li><p>2.构建编码器类描述符</p> <ul><li><p>3.构建AudioConverter，方法：AudioConverterNewSpecific</p> <ul><li><p>4.设置比特率AudioConverterSetProperty</p> <ul><li><p>5.获取packet大小AudioConverterGetProperty</p> <ul><li><p>6.构建outPacketDescription和获取元数据AudioBufferList，方法：AudioConverterFillComplexBuffer(_audioConverter, inInputDataProc, (__bridge void *)(self), &amp;ioOutputDataPacketSize, &amp;outAudioBufferList, outPacketDescription);</p> <ul><li><p>7.构建ADTS头，ADTS总共7个字节</p> <ul><li>子主题 1</li></ul></li></ul></li></ul></li></ul></li></ul></li></ul></li></ul> <h2 id="编码器描述符"><a href="#编码器描述符" class="header-anchor">#</a> 编码器描述符</h2> <h3 id="audioformatgetpropertyinfo-kaudioformatproperty-encoders"><a href="#audioformatgetpropertyinfo-kaudioformatproperty-encoders" class="header-anchor">#</a> AudioFormatGetPropertyInfo(kAudioFormatProperty_Encoders,</h3> <div class="language- extra-class"><pre><code>                                sizeof(encoderSpecifier),
                                &amp;encoderSpecifier,
                                &amp;size);
</code></pre></div><ul><li>1.获取io属性大小:size</li></ul> <h3 id="audioformatgetproperty-kaudioformatproperty-encoders"><a href="#audioformatgetproperty-kaudioformatproperty-encoders" class="header-anchor">#</a> AudioFormatGetProperty(kAudioFormatProperty_Encoders,</h3> <div class="language- extra-class"><pre><code>                            sizeof(encoderSpecifier),
                            &amp;encoderSpecifier,
                            &amp;size,
                            descriptions);
</code></pre></div><ul><li>2.获取支持encoderSpecifier格式的描述符数组</li></ul> <h3 id="for-unsigned-int-i-0-i-count-i"><a href="#for-unsigned-int-i-0-i-count-i" class="header-anchor">#</a> for (unsigned int i = 0; i &lt; count; i++) {</h3> <div class="language- extra-class"><pre><code>    if ((type == descriptions[i].mSubType) &amp;&amp;
        (manufacturer == descriptions[i].mManufacturer)) {
        memcpy(&amp;desc, &amp;(descriptions[i]), sizeof(desc));
        return &amp;desc;
    }
}
</code></pre></div><ul><li>3.遍历描述符数组，找到对应的描述符</li></ul> <p><em>XMind - Trial Version</em></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/iOS笔记/Audio.html" class="prev">
        Audio
      </a></span> <span class="next"><a href="/iOS笔记/AVFoundation.html">
        AVFoundation
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.9de76d75.js" defer></script><script src="/assets/js/2.98ea7a63.js" defer></script><script src="/assets/js/42.a97bf97a.js" defer></script>
  </body>
</html>
